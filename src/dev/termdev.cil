;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(block termdev

       (macro appendinherited_all_chr_files ((type ARG1))
	      (allow ARG1 typeattr appendinherited_chr_file)
	      (allowx ARG1 typeattr (ioctl chr_file (not (0x5412)))))

       (macro dontaudit_readwriteinherited_all_chr_files ((type ARG1))
	      (dontaudit ARG1 typeattr readwriteinherited_chr_file))

       (macro readwriteinherited_all_chr_files ((type ARG1))
	      (allow ARG1 typeattr readwriteinherited_chr_file)
	      (allowx ARG1 typeattr (ioctl chr_file (not (0x5412)))))

       (macro type ((type ARG1))
	      (typeattributeset typeattr ARG1))

       (macro watch_all_chr_files ((type ARG1))
	      (allow ARG1 typeattr (chr_file (watch))))

       (macro watchreads_all_chr_files ((type ARG1))
	      (allow ARG1 typeattr (chr_file (watch_reads))))

       (macro writeinherited_all_chr_files ((type ARG1))
	      (allow ARG1 typeattr writeinherited_chr_file)
	      (allowx ARG1 typeattr (ioctl chr_file (not (0x5412)))))

       (typeattribute typeattr)

       (blockinherit .file.all_macro_template_chr_files)

       (call .dev.type (typeattr))

       (block unconfined

	      (macro type ((type ARG1))
		     (typeattributeset typeattr ARG1))

	      (typeattribute typeattr)

	      (allow typeattr termdev.typeattr
		     (chr_file (not (execmod mounton))))))
