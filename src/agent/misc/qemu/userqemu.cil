;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in file.unconfined

    (call .user.qemu.home.user_home_file_type_transition_file (typeattr)))

(in qemu.img

    (call .user.qemu.home.addname_file_dirs (subj))
    (call .user.qemu.home.manage_file_files (subj)))

(in user

    (call qemu.home.manage_file_dirs (subj))
    (call qemu.home.manage_file_files (subj))
    (call qemu.home.map_file_files (subj))
    (call qemu.home.relabel_file_dirs (subj))
    (call qemu.home.relabel_file_files (subj))
    (call qemu.home.user_home_file_type_transition_file (subj))

    (call qemu.tmp.manage_file_files (subj))
    (call qemu.tmp.manage_file_sock_files (subj))
    (call qemu.tmp.relabel_file_files (subj))
    (call qemu.tmp.relabel_file_sock_files (subj))

    (call qemu.tmpfs.manage_file_files (subj))
    (call qemu.tmpfs.relabel_file_files (subj))

    (call qemu.role (role))
    (call qemu.subj_type_transition (subj))

    (block qemu

	   (macro role ((role ARG1))
		  (roleattributeset roleattr ARG1))

	   (macro subj_type_transition ((type ARG1))
		  (allow ARG1 subj (process (noatsecure transition)))

		  (allow subj ARG1 (process (sigchld)))
		  (allow subj ARG1 (fd (use)))
		  (allow subj ARG1 readwriteinherited_fifo_file)

		  (call .qemu.exec.mapexecute_file_files (ARG1))
		  (call .qemu.exec.read_file_files (ARG1))
		  (call .qemu.exec.subj_type_transition (ARG1 subj)))

	   (macro unix_stream_connect ((type ARG1))
		  (call connectto_subj_unix_stream_sockets (ARG1))
		  (call tmp.write_file_sock_files (ARG1)))

	   (blockinherit .subj.common.base_template)

	   (allow subj self create_tcp_stream_socket)

	   (roleattribute roleattr)
	   (roletype roleattr subj)

	   (call home.manage_file_files (subj))
	   (call home.map_file_files (subj))
	   (call home.readwrite_file_dirs (subj))

	   (call tmp.manage_file_files (subj))
	   (call tmp.manage_file_sock_files (subj))
	   (call tmp.tmp_file_type_transition_file (subj file "*"))
	   (call tmp.tmp_file_type_transition_file (subj sock_file "*"))

	   (call tmpfs.manage_file_files (subj))
	   (call tmpfs.map_file_files (subj))
	   (call tmpfs.tmp_fs_type_transition_file (subj))

	   (call .cert.home.data.list_file_dirs (subj))
	   (call .cert.home.data.read_file_files (subj))

	   (call .ci.getattr_fs_pattern.type (subj))
	   (call .ci.manage_fs_pattern.type (subj))

	   (call .dos.getattr_fs_pattern.type (subj))
	   (call .dos.manage_fs_pattern.type (subj))

	   (call .fuse.getattr_fs_pattern.type (subj))
	   (call .fuse.manage_fs_pattern.type (subj))

	   (call .media.search_file_dirs (subj))

	   (call .media.home.traverse_file_pattern.type (subj))

	   (call .net.port.nameconnect_all_tcp_sockets (subj))
	   (call .net.port.unreserved.namebind_all_tcp_sockets (subj))

	   (call .nfs.getattr_fs_pattern.type (subj))
	   (call .nfs.manage_fs_pattern.type (subj))

	   (call .qemu.common.type (subj))

	   (call .tmp.deletename_file_dirs (subj))

	   (call .user.read_subj_states (subj))

	   (call .user.devpts_fs_type_transition_ptytermdev (subj))
	   (call .user.readwrite_ptytermdev_chr_files (subj))

	   (call .user.home.read_file_files (subj))
	   (call .user.home.map_file_files (subj))

	   (call .user.home.data.search_file_pattern.type (subj))

	   (call .user.agent.type (subj))

	   (call .user.systemd.agent (subj .qemu.exec.file))

	   (block home

		  (filecon "HOME_DIR/\.qemu" dir file_context)
		  (filecon "HOME_DIR/\.qemu/.*" any file_context)

		  (macro map_file_files ((type ARG1))
			 (allow ARG1 file (file (map))))

		  (macro user_home_file_type_transition_file ((type ARG1))
			 (call .user.home.file_type_transition
			       (ARG1 file dir ".qemu")))

		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.user.home.base_template))

	   (block tmp

		  (macro tmp_file_type_transition_file
			 ((type ARG1)(class ARG2)(name ARG3))
			 (call .tmp.file_type_transition
			       (ARG1 file ARG2 ARG3)))

		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.macro_template_sock_files)
		  (blockinherit .file.user.tmp.base_template))

	   (block tmpfs

		  (macro map_file_files ((type ARG1))
			 (allow ARG1 file (file (map))))

		  (macro tmp_fs_type_transition_file ((type ARG1))
			 (call .tmp.fs_type_transition
			       (ARG1 file file "*")))

		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.user.tmpfs.base_template))))

(in wheel

    (call .user.qemu.role (role)))
