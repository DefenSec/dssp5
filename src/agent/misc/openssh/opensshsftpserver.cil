;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in openssh

    (block sftpserver

	   (blockinherit .user.agent.template)

	   (call .cert.read_file_files (subj))
	   (call .cert.search_file_dirs (subj))

	   (call .ci.getattr_fs_pattern.type (subj))
	   (call .ci.manage_fs_pattern.type (subj))

	   (call .crypto.read_sysctlfile_pattern.type (subj))

	   (call .dos.getattr_fs_pattern.type (subj))
	   (call .dos.manage_fs_pattern.type (subj))

	   (call .fuse.getattr_fs_pattern.type (subj))
	   (call .fuse.manage_fs_pattern.type (subj))

	   (call .locale.data.map_file_pattern.type (subj))
	   (call .locale.read_file_pattern.type (subj))

	   (call .media.search_file_dirs (subj))

	   (call .media.home.traverse_file_pattern.type (subj))

	   (call .nfs.getattr_fs_pattern.type (subj))
	   (call .nfs.manage_fs_pattern.type (subj))

	   (call .nss.passwdgroup.type (subj))

	   (call .rbacsep.exemptsource.type (subj))

	   (call .selinux.linked.type (subj))

	   (call .user.home.manage_file_dirs (subj))
	   (call .user.home.manage_file_files (subj))

	   (call .xattr.getattr_fs_pattern.type (subj))

	   (optional opensshsftpserver_p11kit
		     (call .p11kit.conf.read_file_pattern.type (subj))
		     (call .p11kit.data.map_file_files (subj))
		     (call .p11kit.data.read_file_pattern.type (subj)))

	   (optional opensshsftpserver_opensshclient
		     (call client.subj_type_transition (subj)))

	   (block exec

		  (macro getattr_file_files ((type ARG1))
			 (allow ARG1 file (file (getattr))))

		  (filecon "/usr/bin/sftp-server" file file_context))))

(in openssh.server

    (call openssh.sftpserver.exec.getattr_file_files (subj)))

(in user

    (call .openssh.sftpserver.role (role)))

(in wheel

    (call .openssh.sftpserver.role (role)))
