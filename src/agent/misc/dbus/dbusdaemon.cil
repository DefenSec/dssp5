;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in dbus

    (call client.read_all_states (subj))

    (call .sys.read_subj_states (subj))

    (call .sys.user.read_subj_states (subj))

    (block state

	   (filecon "/var/lib/dbus" dir file_context)
	   (filecon "/var/lib/dbus/.*" any file_context)

	   (macro state_file_type_transition_file ((type ARG1))
		  (call .state.file_type_transition
			(ARG1 file dir "dbus")))

	   (blockinherit .file.macro_template_dirs)
	   (blockinherit .file.macro_template_files)
	   (blockinherit .file.state.base_template)))

(in dbus.common

    (call .kernel.search_sysfile_pattern.type (typeattr))

    (call .locale.data.read_file_pattern.type (typeattr))

    (call .security.search_fs_dirs (typeattr))

    (call .systemd.users.run.read_file_files (typeattr))
    (call .systemd.users.run.search_file_dirs (typeattr)))

(in dbus.conf

    (filecon "/etc/default/dbus" file file_context)
    (filecon "/etc/default/dbus\..*" file file_context))

(in dbus.conf.conf_file_type_transition_file

    (call .conf.file_type_transition
	  (ARG1 file file "dbus")))

(in dbus.exec

    (filecon "/usr/bin/dbus-daemon" file file_context))

(in file.unconfined

    (call .dbus.state.state_file_type_transition_file (typeattr)))

;; system dbus-daemon specific method returns

(optional systemdhostname_systemdanalyze

	  (call systemd.analyze.sendmsg_subj_dbus.type (systemd.hostname.subj)))

(optional systemdhostname_systemdhostnamectl

	  (call systemd.hostnamectl.sendmsg_subj_dbus.type
		(systemd.hostname.subj)))

(optional systemdhostname_systemdnetwork

	  (call systemd.network.sendmsg_subj_dbus.type (systemd.hostname.subj)))

(optional systemdlogin_login

	  (call login.sendmsg_subj_dbus.type (systemd.login.subj)))

(optional systemdlogin_systemdloginctl

	  (call systemd.loginctl.sendmsg_subj_dbus.type (systemd.login.subj)))

(optional systemdlogin_opensshserver

	  (call openssh.server.sendmsg_subj_dbus.type (systemd.login.subj)))

(optional systemdlogin_systemduserrundir

	  (call systemd.userrundir.sendmsg_subj_dbus.type
		(systemd.login.subj)))

(optional systemdmachine_systemdnspawn

	  (call systemd.nspawn.sendmsg_subj_dbus.type
		(systemd.machine.subj)))

(optional systemdtimedate_systemdtimedatectl

	  (call systemd.timedatectl.sendmsg_subj_dbus.type
		(systemd.timedate.subj)))

(optional systemdtimesync_systemdtimedatectl

	  (call systemd.timedatectl.sendmsg_subj_dbus.type
		(systemd.timesync.subj)))
