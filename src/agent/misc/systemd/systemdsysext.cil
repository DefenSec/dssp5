;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in file.unconfined

    (call .lostfound.systemd_sysext_ext_state_file_type_transition_file
	  (typeattr))

    (call .systemd.sysext.ext.conf.conf_file_type_transition_file (typeattr))
    (call .systemd.sysext.ext.data.lib_file_type_transition_file (typeattr))
    (call .systemd.sysext.ext.run.run_file_type_transition_file (typeattr))
    (call .systemd.sysext.ext.state.state_file_type_transition_file (typeattr)))

(in lostfound

    (filecon "/var/lib/extensions/\.journal" file ())
    (filecon "/var/lib/extensions/lost\+found" dir file_context)

    (macro systemd_sysext_ext_state_file_type_transition_file ((type ARG1))
	   (call .systemd.sysext.ext.state.file_type_transition
		 (ARG1 file dir "lost+found"))))

(in systemd.sysext

    (blockinherit .hybrid.agent.template)

    (allow subj self (capability (dac_read_search net_admin sys_admin
						  sys_resource)))
    (allow subj self (process (getcap)))
    (allow subj self create_netlink_kobject_uevent_socket)
    (allow subj self create_unix_dgram_socket)

    (call logparsenv.type (subj))
    (call pager.type (subj))

    (call ext.conf.list_file_dirs (subj))
    (call ext.conf.read_file_lnk_files (subj))

    (call ext.run.list_file_dirs (subj))
    (call ext.run.read_file_lnk_files (subj))

    (call ext.state.manage_file_files (subj))
    (call ext.state.readwrite_file_dirs (subj))

    (call run.manage_file_dirs (subj))
    (call run.mounton_file_dirs (subj))
    (call run.systemd_run_file_type_transition_file (subj))

    (call tmp.manage_file_dirs (subj))
    (call tmp.mounton_file_dirs (subj))
    (call tmp.tmp_file_type_transition_file (subj))

    (call tmpfs.manage_file_dirs (subj))
    (call tmpfs.manage_file_files (subj))
    (call tmpfs.mounton_file_dirs (subj))
    (call tmpfs.tmp_fs_type_transition_file (subj dir "*"))

    (call .bus.search_sysfile_pattern.type (subj))

    (call .caplastcap.read_sysctlfile_pattern.type (subj))

    (call .cgroup.getattr_fs_pattern.type (subj))

    (call .class.traverse_sysfile_pattern.type (subj))

    (call .crypto.read_sysctlfile_pattern.type (subj))

    (call .debug.search_fs_pattern.type (subj))

    (call .dev.traverse_sysfile_pattern.type (subj))

    (call .devices.read_sysfile_pattern.type (subj))

    (call .file.data.list_all_dirs (subj))
    (call .file.data.mapexecute_all_files (subj))
    (call .file.data.read_all_files (subj))
    (call .file.data.read_all_lnk_files (subj))
    (call .file.data.mounton_all_dirs (subj))
    (call .file.data.mounton_all_files (subj))

    (call .gcrypt.conf.read_file_pattern.type (subj))

    (call .libnl.conf.read_file_pattern.type (subj))

    (call .loop.readwrite_stordev_blk_files (subj))

    (call .loopcontrol.readwrite_nodedev_chr_files (subj))

    (call .lostfound.dontaudit_auditaccess_dirs (subj))
    (call .lostfound.list_file_dirs (subj))

    (call .osrelease.read_sysctlfile_pattern.type (subj))

    (call .proc.getattr_fs_pattern.type (subj))

    (call .random.read_sysctlfile_pattern.type (subj))

    (call .rbacsep.constrained.type (subj))
    (call .rbacsep.readstatesource.type (subj))
    (call .rbacsep.usefdtarget.type (subj))

    (call .root.mounton_file_dirs (subj))

    (call .run.mounton_file_dirs (subj))

    (call .selinux.linked.type (subj))

    (call .state.search_file_pattern.type (subj))

    (call .stordev.readwrite.type (subj))

    (call .sys.modulerequest_system (subj))

    (call .systemd.journal.relay_msgs.type (subj))

    (call .systemd.nspawn.run.manage_file_dirs (subj))
    (call .systemd.nspawn.run.manage_file_files (subj))
    (call .systemd.nspawn.run.systemd_run_file_type_transition_file (subj))

    (call .systemd.udev.run.read_file_pattern.type (subj))

    (call .tmp.deletename_file_dirs (subj))
    (call .tmp.getattr_fs_pattern.type (subj))
    (call .tmp.mount_fs (subj))

    (call .xattr.getattr_fs_pattern.type (subj))
    (call .xattr.mount_fs (subj))
    (call .xattr.remount_fs (subj))
    (call .xattr.unmount_fs (subj))

    (block exec

	   (filecon "/usr/bin/systemd-sysext" file file_context))

    (block ext

	   (block conf

		  (filecon "/etc/extensions" dir file_context)
		  (filecon "/etc/extensions/.*" any file_context)

		  (macro conf_file_type_transition_file ((type ARG1))
			 (call .conf.file_type_transition
			       (ARG1 file dir "extensions")))

		  (blockinherit .file.conf.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_lnk_files))

	   (block data

		  (filecon "/usr/lib/extension-release\.d" dir file_context)
		  (filecon "/usr/lib/extension-release\.d/.*" any file_context)

		  (filecon "/usr/lib/extensions" dir file_context)
		  (filecon "/usr/lib/extensions/.*" any file_context)

		  (macro lib_file_type_transition_file ((type ARG1))
			 (call .lib.file_type_transition
			       (ARG1 file dir "extension-release.d"))
			 (call .lib.file_type_transition
			       (ARG1 file dir "extensions")))

		  (blockinherit .file.data.template))

	   (block run

		  (filecon "/run/extensions" dir file_context)
		  (filecon "/run/extensions/.*" any file_context)

		  (macro run_file_type_transition_file ((type ARG1))
			 (call .run.file_type_transition
			       (ARG1 file dir "extensions")))

		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_lnk_files)
		  (blockinherit .file.run.template))

	   (block state

		  (filecon "/var/lib/extensions" dir file_context)
		  (filecon "/var/lib/extensions/.*" any ())

		  (macro state_file_type_transition_file ((type ARG1))
			 (call .state.file_type_transition
			       (ARG1 file dir "extensions")))

		  (blockinherit .file.conf.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files)

		  (call .mount.image.type (file))
		  (call .mount.mountpoint.type (file))))

    (block tmp

	   (macro tmp_file_type_transition_file ((type ARG1))
		  (call .tmp.file_type_transition
			(ARG1 file dir "*")))

	   (blockinherit .file.macro_template_dirs)
	   (blockinherit .file.user.tmp.base_template))

    (block tmpfs

	   (macro tmp_fs_type_transition_file
		  ((type ARG1)(class ARG2)(name ARG3))
		  (call .tmp.fs_type_transition
			(ARG1 file ARG2 ARG3)))

	   (blockinherit .file.macro_template_dirs)
	   (blockinherit .file.macro_template_files)
	   (blockinherit .file.user.tmpfs.base_template))

    (block unit

	   (filecon "/usr/lib/systemd/system/systemd-sysext\.service.*"
		    file file_context)

	   (blockinherit .file.unit.template)))

(in subj

    (call .systemd.sysext.use_subj_fds (typeattr))
    (call .systemd.sysext.tmpfs.list_file_dirs (typeattr)))

(in user

    (call .systemd.sysext.tmp.manage_file_dirs (subj))
    (call .systemd.sysext.tmp.relabel_file_dirs (subj))

    (call .systemd.sysext.tmpfs.manage_file_dirs (subj))
    (call .systemd.sysext.tmpfs.manage_file_files (subj))
    (call .systemd.sysext.tmpfs.relabel_file_dirs (subj))
    (call .systemd.sysext.tmpfs.relabel_file_files (subj))

    (call .systemd.sysext.role (role)))

(in wheel

    (call .systemd.sysext.role (role)))
