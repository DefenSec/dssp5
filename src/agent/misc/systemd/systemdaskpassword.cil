;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in systemd.askpassword

    (macro unix_dgram_send ((type ARG1))
	   (call sendto_subj_unix_dgram_sockets (ARG1))
	   (call run.search_file_dirs (ARG1))
	   (call run.write_file_sock_files (ARG1)))

    (blockinherit .hybrid.agent.template)

    (call common.type (subj))

    (call run.manage_file_files (subj))
    (call run.manage_file_sock_files (subj))

    (block client

	   (macro role ((role ARG1))
		  (roleattributeset roleattr ARG1))

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (roleattribute roleattr)
	   (typeattribute typeattr)

	   (call askpassword.role (roleattr))
	   (call askpassword.subj_type_transition (typeattr))

	   (call ttyagent.role (roleattr))
	   (call ttyagent.subj_type_transition (typeattr)))

    (block common

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (typeattribute typeattr)

	   (allow typeattr self (process (setfscreate)))
	   (allow typeattr self create_unix_dgram_socket)

	   (call run.manage_file_dirs (typeattr))
	   (call run.systemd_run_file_type_transition_file (typeattr))

	   (call .caplastcap.read_sysctlfile_pattern.type (typeattr))

	   (call .crypto.read_sysctlfile_pattern.type (typeattr))

	   (call .locale.data.map_file_pattern.type (typeattr))
	   (call .locale.read_file_pattern.type (typeattr))

	   (call .proc.getattr_fs_pattern.type (typeattr))

	   (call .run.search_file_pattern.type (typeattr))

	   (call .selinux.file.read_file_pattern.type (typeattr))
	   (call .selinux.mapread_fs_pattern.type (typeattr)))

    (block exec

	   (filecon "/usr/bin/systemd-ask-password" file file_context))

    (block ttyagent

	   (macro subj_type_transition ((type ARG1))
		  (allow ARG1 subj (process (signal transition)))

		  (allow subj ARG1 (process (sigchld)))
		  (allow subj ARG1 (fd (use)))
		  (allow subj ARG1 readwriteinherited_fifo_file)

		  (call exec.mapexecute_file_files (ARG1))
		  (call exec.read_file_files (ARG1))
		  (call exec.subj_type_transition (ARG1 subj)))

	   (blockinherit .hybrid.agent.template)

	   (allow subj self
		  (capability (dac_override dac_read_search sys_resource
					    sys_tty_config)))

	   (call askpassword.read_subj_states (subj))
	   (call askpassword.unix_dgram_send (subj))

	   (call common.type (subj))

	   (call exec.execute_file_files (subj))

	   (call run.manage_file_fifo_files (subj))
	   (call run.read_file_files (subj))
	   (call run.watch_file_dirs (subj))
	   (call run.watch_file_files (subj))

	   (call systemd.logparsenv.type (subj))

	   (call systemd.journal.relay_msgs.type (subj))

	   (call .cgroup.getattr_fs_pattern.type (subj))

	   (call .class.traverse_sysfile_pattern.type (subj))

	   (call .devices.read_sysfile_files (subj))
	   (call .devices.search_sysfile_pattern.type (subj))

	   (call .devpts.search_fs_pattern.type (subj))

	   (call .osrelease.read_sysctlfile_pattern.type (subj))

	   (call .rbacsep.readstatesource.type (subj))

	   (call .sys.dontaudit_auditaccess_fs_dirs (subj))
	   (call .sys.getattr_fs (subj))

	   (call .termdev.readwrite_all_chr_files (subj))
	   (call .termdev.watch_all_chr_files (subj))
	   (call .termdev.watchreads_all_chr_files (subj))

	   (call .utmp.run.read_file_files (subj))

	   (call .xattr.getattr_fs_pattern.type (subj))

	   (block exec

		  (filecon
		   "/usr/bin/systemd-tty-ask-password-agent" file file_context))

	   (block unit

		  (filecon
		   "/usr/lib/systemd/system/systemd-ask-password-console\.service.*"
		   file file_context)
		  (filecon
		   "/usr/lib/systemd/system/systemd-ask-password-wall\.service.*"
		   file file_context)

		  (blockinherit .file.unit.template))))
