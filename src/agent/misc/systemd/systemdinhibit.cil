;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in systemd.inhibit

    (macro agent ((type ARG1)(type ARG2))
	   (typetransition subj ARG2 process ARG1)
	   (call service.exec.type (ARG2))
	   (call service.type (ARG1)))

    (blockinherit .dbus.client.template)
    (blockinherit .hybrid.agent.template)

    (call service.signal_all_processes (subj))
    (call service.transition_all_processes (subj))

    (call service.exec.mapexecute_all_files (subj))
    (call service.exec.read_all_files (subj))

    (call service.noatsecure.noatsecure_all_processes (subj))

    (call systemd.pager.type (subj))

    (call systemd.askpassword.client.type (subj))

    (call systemd.login.inhibit.read_all_states (subj))
    (call systemd.login.inhibit.type (subj))
    (call systemd.login.sendmsg_subj_dbus.type (subj))

    (call .caplastcap.read_sysctlfile_pattern.type (subj))

    (call .cgroup.getattr_fs_pattern.type (subj))

    (call .crypto.read_sysctlfile_pattern.type (subj))

    (call .locale.data.map_file_pattern.type (subj))
    (call .locale.read_file_pattern.type (subj))

    (call .nss.passwdgroup.type (subj))

    (call .proc.getattr_fs_pattern.type (subj))

    (call .rbacsep.constrained.type (subj))
    (call .rbacsep.readstatesource.type (subj))

    (call .selinux.linked.type (subj))

    (call .subj.dontaudit_read_all_states (subj))

    (call .sys.read_subj_states (subj))

    (optional systemdinhibit_exechomefile
	      (call .user.exec_home_subj_type_transition (subj)))

    (optional systemdinhibit_polkit
	      (call .polkit.ttyagent.subj_type_transition (subj)))

    (optional systemginhibit_unprivuser
	      (call .user.exec_subj_type_transition (subj))
	      (call .user.shell_exec_subj_type_transition (subj))
	      (call .user.signal_subj_processes (subj)))

    (block exec

	   (filecon "/usr/bin/systemd-inhibit" file file_context))

    (block service

	   (macro signal_all_processes ((type ARG1))
		  (allow ARG1 typeattr (process (signal))))

	   (macro transition_all_processes ((type ARG1))
		  (allow ARG1 typeattr (process (transition))))

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (typeattribute typeattr)

	   (call use_subj_fds (typeattr))

	   (call systemd.login.inhibit.type (typeattr))

	   (block exec

		  (macro mapexecute_all_files ((type ARG1))
			 (allow ARG1 typeattr mapexecute_file))

		  (macro read_all_files ((type ARG1))
			 (allow ARG1 typeattr read_file))

		  (macro type ((type ARG1))
			 (typeattributeset typeattr ARG1))

		  (typeattribute typeattr))

	   (block noatsecure

		  (macro noatsecure_all_processes ((type ARG1))
			 (allow ARG1 subj (process (noatsecure))))

		  (macro type ((type ARG1))
			 (typeattributeset typeattr ARG1))

		  (typeattribute typeattr))))
