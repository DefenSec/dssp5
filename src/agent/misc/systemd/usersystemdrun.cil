;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in user

    (call .user.systemd.run.pipe.type (subj))
    (call .user.systemd.run.role (role))
    (call .user.systemd.run.subj_type_transition (subj)))

(in user.dbus

    (call .user.systemd.run.pipe.client.type (subj)))

(in user.systemd.run

    (macro agent ((type ARG1)(type ARG2))
	   (typetransition subj ARG2 process ARG1)
	   (call service.exec.type (ARG2))
	   (call service.type (ARG1)))

    (macro role ((role ARG1))
	   (roleattributeset roleattr ARG1))

    (macro subj_type_transition ((type ARG1))
	   (allow ARG1 subj (process (noatsecure transition)))

	   (allow subj ARG1 (process (sigchld)))
	   (allow subj ARG1 (fd (use)))
	   (allow subj ARG1 readwriteinherited_fifo_file)

	   (call .systemd.run.exec.mapexecute_file_files (ARG1))
	   (call .systemd.run.exec.read_file_files (ARG1))
	   (call .systemd.run.exec.subj_type_transition (ARG1 subj)))

    (macro use_subj_fds ((type ARG1))
	   (allow ARG1 subj (fd (use))))

    (blockinherit .user.dbus.client.template)
    (blockinherit .subj.common.base_template)

    (roleattribute roleattr)
    (roletype roleattr subj)

    (call service.transition_all_processes (subj))

    (call service.exec.mapexecute_all_files (subj))
    (call service.exec.read_all_files (subj))

    (call service.noatsecure.noatsecure_all_processes (subj))

    ;; this can't work reliably, use 'systemd.run.subj_type_transition()'
    ;; 'systemd.run.role()' and 'systemd.run.pipe.type()' with a priv
    ;; role and type. alternatively use 'systemd-run -H root@localhost'
    ;; but that will get you no --pty / --pipe functionality
    (call .dbus.run.dontaudit_search_file_dirs (subj))

    (call .rbacsep.readstatesource.type (subj))

    (call .systemd.run.common.type (subj))
    (call .systemd.run.exec.entrypoint_file_files (subj))
    (call .systemd.run.exec.mapexecute_file_files (subj))
    (call .systemd.run.exec.read_file_files (subj))

    (call .systemd.run.search_file_dirs (subj))

    (call .user.agent.exec.auditexecuteaccess_all_files (subj))
    (call .user.agent.type (subj))

    (call .user.exec_subj_type_transition (subj))

    (call .user.exec_home_subj_type_transition (subj))

    (call .user.devpts_fs_type_transition_ptytermdev (subj))

    (call .user.shell_exec_subj_type_transition (subj))

    (call .user.systemd.notify.type (subj))
    (call .user.systemd.private.type (subj))
    (call .user.systemd.sendmsg_subj_dbus.type (subj))
    (call .user.systemd.start_system (subj))
    (call .user.systemd.status_system (subj))
    (call .user.systemd.unit.run.start_file_services (subj))
    (call .user.systemd.unit.run.status_file_services (subj))

    (call .user.termdev.open_all_chr_files (subj))

    (block pipe

	   (macro readwriteinherited_all_fifo_files ((type ARG1))
		  (allow ARG1 typeattr readwriteinherited_fifo_file))

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (macro use_all_fds ((type ARG1))
		  (allow ARG1 typeattr (fd (use))))

	   (typeattribute typeattr)

	   (block client

		  (macro type ((type ARG1))
			 (typeattributeset typeattr ARG1))

		  (typeattribute typeattr)

		  (call pipe.readwriteinherited_all_fifo_files (typeattr))
		  (call pipe.use_all_fds (typeattr))

		  (call .user.termdev.readwriteinherited_all_chr_files
			(typeattr))))

    (block service

	   (macro transition_all_processes ((type ARG1))
		  (allow ARG1 typeattr (process (transition))))

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (typeattribute typeattr)

	   (block exec

		  (macro mapexecute_all_files ((type ARG1))
			 (allow ARG1 typeattr mapexecute_file))

		  (macro read_all_files ((type ARG1))
			 (allow ARG1 typeattr read_file))

		  (macro type ((type ARG1))
			 (typeattributeset typeattr ARG1))

		  (typeattribute typeattr))

	   (block noatsecure

		  (macro noatsecure_all_processes ((type ARG1))
			 (allow ARG1 subj (process (noatsecure))))

		  (macro type ((type ARG1))
			 (typeattributeset typeattr ARG1))

		  (typeattribute typeattr))))

(in wheel

    (call .user.systemd.run.role (role)))
