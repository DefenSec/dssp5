;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(block dovecot

       (macro agent ((type ARG1)(type ARG2))
	      (typetransition subj ARG2 process ARG1)
	      (call service.exec.type (ARG2))
	      (call service.type (ARG1)))

       (macro accept_subj_tcp_sockets ((type ARG1))
	      (allow ARG1 subj (tcp_socket (accept))))

       (macro accept_subj_unix_stream_sockets ((type ARG1))
	      (allow ARG1 subj (unix_stream_socket (accept))))

       (macro readwrite_subj_tcp_sockets ((type ARG1))
	      (allow ARG1 subj readwrite_tcp_socket))

       (macro unix_stream_connect ((type ARG1))
	      (call connectto_subj_unix_stream_sockets (ARG1))
	      (call run.search_file_dirs (ARG1))
	      (call run.write_file_sock_files (ARG1)))

       (macro unix_stream_connect_login ((type ARG1))
	      (call connectto_subj_unix_stream_sockets (ARG1))
	      (call login.run.search_file_dirs (ARG1))
	      (call login.run.write_file_sock_files (ARG1))
	      (call run.search_file_dirs (ARG1)))

       (macro unix_stream_connect_tokenlogin ((type ARG1))
	      (call connectto_subj_unix_stream_sockets (ARG1))
	      (call tokenlogin.run.search_file_dirs (ARG1))
	      (call tokenlogin.run.write_file_sock_files (ARG1))
	      (call run.search_file_dirs (ARG1)))

       (blockinherit .sys.agent.template)

       (allow subj self
	      (capability (chown dac_override dac_read_search fsetid kill
				 net_bind_service)))
       (allow subj self (process (setcap)))
       (allow subj self create_tcp_stream_socket)
       (allow subj self create_unix_dgram_socket)
       (allow subj self (unix_stream_socket (accept connectto listen)))

       (call cli.signal_subj_processes (subj))
       (call cli.subj_type_transition (subj))

       (call common.type (subj))

       (call conf.getattr_file_files (subj))
       (call conf.read_file_lnk_files (subj))
       (call conf.search_file_dirs (subj))

       (call empty.run.manage_file_dirs (subj))
       (call empty.run.dovecot_run_file_type_transition_file (subj))

       (call login.run.manage_file_dirs (subj))
       (call login.run.manage_file_sock_files (subj))
       (call login.run.dovecot_run_file_type_transition_file (subj))

       (call run.manage_file_dirs (subj))
       (call run.manage_file_fifo_files (subj))
       (call run.manage_file_files (subj))
       (call run.manage_file_lnk_files (subj))
       (call run.manage_file_sock_files (subj))
       (call run.run_file_type_transition_file (subj))

       (call service.exec.mapexecute_all_files (subj))
       (call service.exec.read_all_files (subj))

       (call service.signal_all_processes (subj))
       (call service.transition_all_processes (subj))

       (call state.manage_file_dirs (subj))
       (call state.manage_file_files (subj))

       (call tokenlogin.run.manage_file_dirs (subj))
       (call tokenlogin.run.manage_file_sock_files (subj))
       (call tokenlogin.run.dovecot_run_file_type_transition_file (subj))

       (call .corepattern.getattr_sysctlfile_files (subj))

       ;; /usr/libexec/dovecot/replicator
       (call .exec.execute_file_files (subj))

       (call .fs.getattr_sysctlfile_files (subj))
       (call .fs.search_sysctlfile_pattern.type (subj))

       (call .imap.namebind_port_tcp_sockets (subj))
       (call .imap.imaps.namebind_port_tcp_sockets (subj))

       (call .kernel.search_sysctlfile_pattern.type (subj))

       (call .net.nodebind_netnode_tcp_sockets (subj))

       (call .nss.hosts.type (subj))

       (call .pop.namebind_port_tcp_sockets (subj))
       (call .pop.pops.namebind_port_tcp_sockets (subj))

       (call .rbacsep.constrained.type (subj))
       (call .rbacsep.usefdsource.type (subj))

       (call .sieve.namebind_port_tcp_sockets (subj))

       (call .spool.search_file_pattern.type (subj))

       (call .systemd.journal.relay_msgs.type (subj))

       (optional dovecot_postfix
		 (call .postfix.private.spool.manage_file_sock_files (subj))
		 (call .postfix.private.spool.readwrite_file_dirs (subj))
		 (call .postfix.spool.search_file_dirs (subj)))

       (block anvil

	      (blockinherit .agent.template)

	      (call agent (subj exec.file))
	      (call unix_stream_connect (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/anvil" file file_context)))

       (block auth

	      (blockinherit .agent.template)

	      (allow subj self (capability (audit_write)))
	      (allow subj self (process (getcap)))
	      (allow subj self create_netlink_audit_socket)
	      (allow subj self create_netlink_route_socket)
	      (allow subj self create_unix_dgram_socket)
	      (allow subj self (netlink_audit_socket (nlmsg_relay)))
	      (allow subj self (netlink_route_socket (nlmsg_read)))

	      (call conf.list_file_dirs (subj))
	      (call conf.read_file_files (subj))

	      (call dovecot.agent (subj exec.file))
	      (call dovecot.unix_stream_connect (subj))

	      (call spool.read_file_files (subj))
	      (call spool.search_file_dirs (subj))

	      (call run.manage_file_files (subj))
	      (call run.readwrite_file_dirs (subj))
	      (call run.write_file_fifo_files (subj))

	      (call .caplastcap.read_sysctlfile_pattern.type (subj))

	      (call .mail.search_file_pattern.type (subj))

	      (call .pam.linked.type (subj))

	      (call .proc.getattr_fs_pattern.type (subj))

	      (call .random.read_sysctlfile_pattern.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .systemd.journal.relay_msgs.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/auth" file file_context)))

       (block cert

	      (filecon "/etc/pki/dovecot" dir file_context)
	      (filecon "/etc/pki/dovecot/.*" any file_context)

	      (macro cert_file_type_transition_file ((type ARG1))
		     (call .cert.file_type_transition
			   (ARG1 file dir "dovecot")))

	      (blockinherit .file.cert.template))

       (block cli

	      (blockinherit .sys.agent.template)

	      (allow subj self
		     (capability (dac_override dac_read_search net_admin setgid
					       setuid)))
	      (dontaudit subj self (capability (sys_ptrace)))

	      (call cert.list_file_dirs (subj))
	      (call cert.read_file_files (subj))

	      (call common.type (subj))

	      (call conf.list_file_dirs (subj))
	      (call conf.read_file_files (subj))

	      (call config.readwriteinherited_subj_fifo_files (subj))
	      (call config.signal_subj_processes (subj))
	      (call config.use_subj_fds (subj))

	      (call dovecot.signal_subj_processes (subj))
	      (call dovecot.signull_subj_processes (subj))
	      (call dovecot.subj_type_transition (subj))
	      (call dovecot.readwrite_subj_unix_stream_sockets (subj))
	      (call dovecot.unix_stream_connect (subj))

	      (call exec.execute_file_files (subj))

	      (call run.list_file_dirs (subj))
	      (call run.read_file_files (subj))
	      (call run.read_file_lnk_files (subj))

	      (call spool.manage_file_dirs (subj))
	      (call spool.manage_file_files (subj))
	      (call spool.map_file_files (subj))

	      (call state.list_file_dirs (subj))
	      (call state.read_file_files (subj))

	      (call .cert.read_file_files (subj))
	      (call .cert.traverse_file_pattern.type (subj))

	      (call .cgroup.getattr_fs_pattern.type (subj))

	      (call .cmdline.read_procfile_pattern.type (subj))

	      (call .mail.search_file_pattern.type (subj))

	      (call .nss.hosts.type (subj))

	      (call .osrelease.read_sysctlfile_pattern.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.readstatesource.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .sys.read_subj_states (subj))

	      (optional dovecot_cli_certbot
			(call .certbot.conf.read_file_pattern.type (subj)))

	      (block exec

		     (filecon "/usr/bin/doveadm" file file_context)
		     (filecon "/usr/bin/doveconf" file file_context)))

       (block common

	      (macro type ((type ARG1))
		     (typeattributeset typeattr ARG1))

	      (typeattribute typeattr)

	      (allow typeattr self (process (getsched setrlimit setsched)))

	      (call .crypto.read_sysctlfile_pattern.type (typeattr))

	      (call .lib.list_file_dirs (typeattr))

	      (call .locale.data.map_file_pattern.type (typeattr))
	      (call .locale.data.read_file_pattern.type (typeattr))

	      (call .nss.passwdgroup.type (typeattr))

	      (call .selinux.linked.type (typeattr))

	      (call .state.search_file_pattern.type (typeattr)))

       (block conf

	      (filecon "/etc/dovecot" dir file_context)
	      (filecon "/etc/dovecot/.*" any file_context)

	      (macro conf_file_type_transition_file ((type ARG1))
		     (call .conf.file_type_transition
			   (ARG1 file dir "dovecot")))

	      (macro getattr_file_files ((type ARG1))
		     (allow ARG1 file (file (getattr))))

	      (blockinherit .file.conf.template))

       (block config

	      (blockinherit .agent.template)

	      (allow subj self (capability (dac_read_search)))

	      (call cert.list_file_dirs (subj))
	      (call cert.read_file_files (subj))

	      (call conf.list_file_dirs (subj))
	      (call conf.read_file_files (subj))

	      (call dovecot.agent (subj exec.file))

	      (call state.search_file_dirs (subj))

	      (call .cert.read_file_files (subj))
	      (call .cert.traverse_file_pattern.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (optional dovecot_config_certbot
			(call .certbot.conf.read_file_pattern.type (subj)))

	      (block exec

		     (filecon "/usr/bin/dovecot/config" file file_context)))

       (block empty

	      (block run

		     (filecon "/run/dovecot/empty" dir file_context)
		     (filecon "/run/dovecot/empty/.*" any file_context)

		     (macro dovecot_run_file_type_transition_file ((type ARG1))
			    (call .dovecot.run.file_type_transition
				  (ARG1 file dir "empty")))

		     (blockinherit .file.macro_template_dirs)
		     (blockinherit .file.run.dovecot.base_template)))

       (block exec

	      (filecon "/usr/bin/dovecot" file file_context))

       (block imap

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))
	      (call dovecot.unix_stream_connect (subj))

	      (call imaplogin.readwrite_subj_unix_stream_sockets (subj))
	      (call imaplogin.use_subj_fds (subj))

	      (call spool.manage_file_dirs (subj))
	      (call spool.manage_file_files (subj))
	      (call spool.map_file_files (subj))
	      (call spool.watch_file_dirs (subj))
	      (call spool.watch_file_files (subj))

	      (call .ci.getattr_fs_pattern.type (subj))
	      (call .ci.manage_fs_pattern.type (subj))

	      (call .dos.getattr_fs_pattern.type (subj))
	      (call .dos.manage_fs_pattern.type (subj))

	      (call .fuse.getattr_fs_pattern.type (subj))
	      (call .fuse.manage_fs_pattern.type (subj))

	      (call .home.search_file_pattern.type (subj))

	      (call .mail.search_file_pattern.type (subj))

	      (call .mail.home.manage_file_dirs (subj))
	      (call .mail.home.manage_file_files (subj))
	      (call .mail.home.map_file_files (subj))
	      (call .mail.home.user_home_file_type_transition_file (subj))

	      (call .nfs.getattr_fs_pattern.type (subj))
	      (call .nfs.manage_fs_pattern.type (subj))

	      (call .user.mail.readwrite_file_files (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/imap" file file_context)))

       (block imaplogin

	      (blockinherit .agent.template)

	      (call cert.list_file_dirs (subj))
	      (call cert.read_file_files (subj))

	      (call dovecot.accept_subj_tcp_sockets (subj))
	      (call dovecot.agent (subj exec.file))
	      (call dovecot.readwrite_subj_tcp_sockets (subj))
	      (call dovecot.unix_stream_connect (subj))
	      (call dovecot.unix_stream_connect_login (subj))

	      (call run.readwriteinherited_file_files (subj))

	      (call .cert.read_file_files (subj))
	      (call .cert.traverse_file_pattern.type (subj))

	      (call .cryptopol.conf.read_file_files (subj))
	      (call .cryptopol.conf.traverse_file_pattern.type (subj))

	      (call .cryptopol.data.read_file_files (subj))
	      (call .cryptopol.data.search_file_pattern.type (subj))

	      (call .gcrypt.conf.read_file_pattern.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/imap-login" file file_context)))

       (block lda

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/dovecot-lda" file
			      file_context)))

       (block lmtp

	      (blockinherit .agent.template)

	      (allow subj self (capability (dac_override dac_read_search)))

	      (call cert.list_file_dirs (subj))
	      (call cert.read_file_files (subj))

	      (call dovecot.agent (subj exec.file))
	      (call dovecot.unix_stream_connect (subj))

	      (call spool.manage_file_dirs (subj))
	      (call spool.manage_file_files (subj))
	      (call spool.map_file_files (subj))
	      (call spool.read_file_lnk_files (subj))

	      (call state.list_file_dirs (subj))
	      (call state.read_file_files (subj))

	      (call tmp.manage_file_files (subj))
	      (call tmp.tmp_file_type_transition_file (subj))

	      (call .cert.read_file_files (subj))
	      (call .cert.traverse_file_pattern.type (subj))

	      (call .ci.getattr_fs_pattern.type (subj))
	      (call .ci.manage_fs_pattern.type (subj))

	      (call .cryptopol.conf.read_file_files (subj))
	      (call .cryptopol.conf.traverse_file_pattern.type (subj))

	      (call .cryptopol.data.read_file_files (subj))
	      (call .cryptopol.data.search_file_pattern.type (subj))

	      (call .dos.getattr_fs_pattern.type (subj))
	      (call .dos.manage_fs_pattern.type (subj))

	      (call .fuse.getattr_fs_pattern.type (subj))
	      (call .fuse.manage_fs_pattern.type (subj))

	      (call .gcrypt.conf.read_file_pattern.type (subj))

	      (call .home.search_file_pattern.type (subj))

	      (call .mail.search_file_pattern.type (subj))

	      (call .mail.home.manage_file_dirs (subj))
	      (call .mail.home.manage_file_files (subj))
	      (call .mail.home.map_file_files (subj))
	      (call .mail.home.user_home_file_type_transition_file (subj))

	      (call .nfs.getattr_fs_pattern.type (subj))
	      (call .nfs.manage_fs_pattern.type (subj))

	      (call .tmp.deletename_file_dirs (subj))

	      (optional dovecot_lmtp_postfix
			(call .postfix.sendmail.mailer.type (subj)))

	      (block exec

		     (filecon "/usr/bin/dovecot/lmtp" file file_context))

	      (block tmp

		     (macro tmp_file_type_transition_file ((type ARG1))
			    (call .tmp.file_type_transition
				  (ARG1 file file "*")))

		     (blockinherit .file.macro_template_files)
		     (blockinherit .file.tmp.base_template)))

       (block log

	      (blockinherit .agent.template)

	      (allow subj self create_unix_dgram_socket)

	      (call dovecot.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .systemd.journal.relay_msgs.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/log" file file_context)))

       (block login

	      (block run

		     (filecon "/run/dovecot/login" dir file_context)
		     (filecon "/run/dovecot/login/.*" any file_context)

		     (macro dovecot_run_file_type_transition_file ((type ARG1))
			    (call .dovecot.run.file_type_transition
				  (ARG1 file dir "login")))

		     (blockinherit .file.run.dovecot.template)))

       (block mkcert

	      (blockinherit .sys.agent.template)

	      (call cert.manage_file_files (subj))
	      (call cert.readwrite_file_dirs (subj))

	      (call common.type (subj))

	      (call .cert.read_file_files (subj))
	      (call .cert.traverse_file_pattern.type (subj))

	      (call .cryptopol.conf.read_file_files (subj))
	      (call .cryptopol.conf.traverse_file_pattern.type (subj))

	      (call .cryptopol.data.read_file_files (subj))
	      (call .cryptopol.data.search_file_pattern.type (subj))

	      (call .exec.execute_file_files (subj))

	      (call .gcrypt.conf.read_file_pattern.type (subj))

	      (call .openssl.exec.execute_file_files (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .shell.exec.mapexecute_file_files (subj))
	      (call .shell.exec.read_file_files (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/mkcert\.sh" file file_context)))

       (block pop3

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))
	      (call dovecot.unix_stream_connect (subj))

	      (call pop3login.readwrite_subj_unix_stream_sockets (subj))
	      (call pop3login.use_subj_fds (subj))

	      (call .ci.getattr_fs_pattern.type (subj))
	      (call .ci.manage_fs_pattern.type (subj))

	      (call .dos.getattr_fs_pattern.type (subj))
	      (call .dos.manage_fs_pattern.type (subj))

	      (call .fuse.getattr_fs_pattern.type (subj))
	      (call .fuse.manage_fs_pattern.type (subj))

	      (call .home.search_file_pattern.type (subj))

	      (call .mail.home.manage_file_dirs (subj))
	      (call .mail.home.manage_file_files (subj))
	      (call .mail.home.map_file_files (subj))
	      (call .mail.home.user_home_file_type_transition_file (subj))

	      (call .nfs.getattr_fs_pattern.type (subj))
	      (call .nfs.manage_fs_pattern.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/pop3" file file_context)))

       (block pop3login

	      (blockinherit .agent.template)

	      (call dovecot.accept_subj_tcp_sockets (subj))
	      (call dovecot.agent (subj exec.file))
	      (call dovecot.readwrite_subj_tcp_sockets (subj))
	      (call dovecot.unix_stream_connect (subj))
	      (call dovecot.unix_stream_connect_login (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/pop3-login" file file_context)))

       (block run

	      (filecon "/run/dovecot" dir file_context)
	      (filecon "/run/dovecot/.*" any file_context)

	      (macro run_file_type_transition_file ((type ARG1))
		     (call .run.file_type_transition
			   (ARG1 file dir "dovecot")))

	      (blockinherit .file.macro_template_fifo_files)
	      (blockinherit .file.macro_template_files)
	      (blockinherit .file.macro_template_lnk_files)
	      (blockinherit .file.run.dovecot.template))

       (block script

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/script" file file_context)))

       (block scriptlogin

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/script-login" file
			      file_context)))

       (block service

	      (macro signal_all_processes ((type ARG1))
		     (allow ARG1 typeattr (process (signal))))

	      (macro transition_all_processes ((type ARG1))
		     (allow ARG1 typeattr (process (transition))))

	      (macro type ((type ARG1))
		     (typeattributeset typeattr ARG1))

	      (typeattribute typeattr)

	      (allow typeattr self (capability (setgid setuid sys_chroot)))

	      (call common.type (typeattr))

	      (call dovecot.accept_subj_unix_stream_sockets (typeattr))
	      (call dovecot.readwrite_subj_unix_stream_sockets (typeattr))
	      (call dovecot.readwriteinherited_subj_fifo_files (typeattr))
	      (call dovecot.sigchld_subj_processes (typeattr))
	      (call dovecot.use_subj_fds (typeattr))

	      (call empty.run.search_file_dirs (typeattr))

	      (call .sys.agent.type (typeattr))

	      (block exec

		     (macro mapexecute_all_files ((type ARG1))
			    (allow ARG1 typeattr mapexecute_file))

		     (macro read_all_files ((type ARG1))
			    (allow ARG1 typeattr read_file))

		     (macro type ((type ARG1))
			    (typeattributeset typeattr ARG1))

		     (typeattribute typeattr)

		     (call .sys.agent.exec.type (typeattr))))

       (block spool

	      (filecon "/var/spool/dovecot" dir file_context)
	      (filecon "/var/spool/dovecot/.*" any file_context)

	      (filecon "/var/vmail" dir file_context)
	      (filecon "/var/vmail/.*" any file_context)

	      (macro map_file_files ((type ARG1))
		     (allow ARG1 file (file (map))))

	      (macro spool_file_type_transition_file ((type ARG1))
		     (call .spool.file_type_transition
			   (ARG1 file dir "dovecot")))

	      (macro var_file_type_transition_file ((type ARG1))
		     (call .var.file_type_transition
			   (ARG1 file dir "vmail")))

	      (macro watch_file_dirs ((type ARG1))
		     (allow ARG1 file (dir (watch))))

	      (macro watch_file_files ((type ARG1))
		     (allow ARG1 file (file (watch))))

	      (blockinherit .file.spool.template))

       (block state

	      (filecon "/var/lib/dovecot" dir file_context)
	      (filecon "/var/lib/dovecot/.*" any file_context)

	      (macro state_file_type_transition_file ((type ARG1))
		     (call .state.file_type_transition
			   (ARG1 file dir "dovecot")))

	      (blockinherit .file.state.dovecot.template))

       (block stats

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))
	      (call dovecot.unix_stream_connect (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/stats" file file_context)))

       (block submission

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/submission" file file_context)))

       (block submissionlogin

	      (blockinherit .agent.template)

	      (call dovecot.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/dovecot/submission-login" file
			      file_context)))

       (block tokenlogin

	      (block run

		     (filecon "/run/dovecot/token-login" dir file_context)
		     (filecon "/run/dovecot/token-login/.*" any file_context)

		     (macro dovecot_run_file_type_transition_file ((type ARG1))
			    (call .dovecot.run.file_type_transition
				  (ARG1 file dir "token-login")))

		     (blockinherit .file.run.dovecot.template)))

       (block unit

	      (filecon "/usr/lib/systemd/system/dovecot\.service.*" file
		       file_context)
	      (filecon "/usr/lib/systemd/system/dovecot\.socket.*" file
		       file_context)
	      (filecon "/usr/lib/systemd/system/dovecot-init\.service.*" file
		       file_context)

	      (blockinherit .file.unit.template)))

(in file.run

    (block dovecot

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_fifo_files)
	   (blockinherit file.all_macro_template_files)
	   (blockinherit file.all_macro_template_lnk_files)
	   (blockinherit file.all_macro_template_sock_files)

	   (typeattribute typeattr)

	   (call file.run.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.run.base_template)

		  (call .file.run.dovecot.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.run.dovecot.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_sock_files))))

(in file.state

    (block dovecot

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)
	   (blockinherit file.all_macro_template_lnk_files)

	   (typeattribute typeattr)

	   (call file.state.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.state.base_template)

		  (call .file.state.dovecot.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.state.dovecot.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files))))

(in file.unconfined

    (call .dovecot.cert.cert_file_type_transition_file (typeattr))
    (call .dovecot.conf.conf_file_type_transition_file (typeattr))
    (call .dovecot.empty.run.dovecot_run_file_type_transition_file (typeattr))
    (call .dovecot.login.run.dovecot_run_file_type_transition_file (typeattr))
    (call .dovecot.run.run_file_type_transition_file (typeattr))
    (call .dovecot.spool.spool_file_type_transition_file (typeattr))
    (call .dovecot.spool.var_file_type_transition_file (typeattr))
    (call .dovecot.state.state_file_type_transition_file (typeattr))
    (call .dovecot.tokenlogin.run.dovecot_run_file_type_transition_file
	  (typeattr)))
