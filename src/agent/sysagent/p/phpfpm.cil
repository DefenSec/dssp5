;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in file.conf

    (block phpfpm

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)
	   (blockinherit file.all_macro_template_lnk_files)

	   (typeattribute typeattr)

	   (call file.conf.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.conf.base_template)

		  (call .file.conf.phpfpm.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.conf.phpfpm.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.macro_template_lnk_files))))

(in file.log

    (block phpfpm

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)

	   (typeattribute typeattr)

	   (call file.log.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.log.base_template)

		  (call .file.log.phpfpm.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.log.phpfpm.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files))))

(in file.run

    (block phpfpm

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)
	   (blockinherit file.all_macro_template_sock_files)

	   (typeattribute typeattr)

	   (call file.run.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.run.base_template)

		  (call .file.run.phpfpm.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.run.phpfpm.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.macro_template_sock_files))))

(in file.state.php

    (block phpfpm

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)

	   (typeattribute typeattr)

	   (call .file.state.php.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.state.php.base_template)

		  (call .file.state.php.phpfpm.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.state.php.phpfpm.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files))))

(in file.tmp

    (block phpfpm

	   (macro map_all_file_files ((type ARG1))
		  (allow ARG1 typeattr (file (map))))

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_files)

	   (typeattribute typeattr)

	   (call file.tmp.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.tmp.base_template)

		  (call .file.tmp.phpfpm.type (file)))

	   (block template

		  (macro map_file_files ((type ARG1))
			 (allow ARG1 file (file (map))))

		  (macro tmp_file_type_transition_file ((type ARG1))
			 (call .tmp.file_type_transition
			       (ARG1 file file "*")))

		  (blockabstract template)

		  (blockinherit .file.tmp.phpfpm.base_template)
		  (blockinherit .file.macro_template_files))))

(in file.unconfined

    (call .phpfpm.conf.conf_file_type_transition_file (typeattr))
    (call .phpfpm.data.data_file_type_transition_file (typeattr))
    (call .phpfpm.log.log_file_type_transition_file (typeattr))
    (call .phpfpm.run.run_file_type_transition_file (typeattr))
    (call .phpfpm.state.php_state_file_type_transition_file (typeattr)))

(in file.unit

    (block phpfpm

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_files)

	   (typeattribute typeattr)

	   (call file.unit.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.unit.base_template)

		  (call .file.unit.phpfpm.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.unit.phpfpm.base_template)
		  (blockinherit .file.macro_template_files))))

(in phpfpm

    (blockinherit instance.template)

    (allow subj self create_tcp_stream_socket)

    (call namebind_port_tcp_sockets (subj))

    (call exec.subj_type_transition (.sys.subj subj))

    (call log.log_file_type_transition_file (subj))
    (call run.run_file_type_transition_file (subj))

    (call .http.nameconnect_port_tcp_sockets (subj))
    (call .http.https.nameconnect_port_tcp_sockets (subj))

    (call .net.nodebind_netnode_tcp_sockets (subj))

    (call .nss.hosts.type (subj))

    (call .smtp.msa.nameconnect_port_tcp_sockets (subj))
    (call .smtp.nameconnect_port_tcp_sockets (subj))
    (call .smtp.smtps.nameconnect_port_tcp_sockets (subj))

    (call .web.ra.append_file_files (subj))
    (call .web.ra.create_file_files (subj))
    (call .web.ra.delete_file_files (subj))
    (call .web.ra.map_file_files (subj))
    (call .web.ra.read_file_files (subj))
    (call .web.ra.readwrite_file_dirs (subj))
    (call .web.ra.rename_file_files (subj))
    (call .web.ra.setattr_file_files (subj))

    (call .web.ro.list_file_dirs (subj))
    (call .web.ro.map_file_files (subj))
    (call .web.ro.read_file_files (subj))

    (call .web.rw.manage_file_dirs (subj))
    (call .web.rw.manage_file_fifo_files (subj))
    (call .web.rw.manage_file_files (subj))
    (call .web.rw.manage_file_lnk_files (subj))
    (call .web.rw.manage_file_sock_files (subj))
    (call .web.rw.map_file_files (subj))

    (call .web.script.exec.list_file_dirs (subj))
    (call .web.script.exec.map_file_files (subj))
    (call .web.script.exec.read_file_files (subj))

    (optional phpfpm_postfix
	      (call .postfix.sendmail.mailer.type (subj))
	      (call .postfix.sendmail.mailer.tmp.type (tmp.file)))

    (block conf

	   (filecon "/etc/php-fpm\.conf" file file_context)
	   (filecon "/etc/php-fpm\.conf\..*" file file_context)
	   (filecon "/etc/php-fpm\.d" dir file_context)
	   (filecon "/etc/php-fpm\.d/.*" any file_context)

	   (macro conf_file_type_transition_file ((type ARG1))
		  (call .conf.file_type_transition
			(ARG1 file file "php-fpm.conf"))
		  (call .conf.file_type_transition
			(ARG1 file dir "php-fpm.d"))))

    (block data

	   (filecon "/usr/share/fpm" dir file_context)
	   (filecon "/usr/share/fpm/.*" any file_context)

	   (macro data_file_type_transition_file ((type ARG1))
		  (call .data.file_type_transition
			(ARG1 file dir "fpm")))

	   (blockinherit .file.data.template))

    (block exec

	   (filecon "/usr/bin/php-fpm" file file_context)

	   (blockinherit .file.exec.template)

	   (call .sys.agent.exec.type (file)))

    (block instance

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (macro unix_stream_connect ((type ARG1))
		  (call connectto_all_unix_stream_sockets (ARG1))
		  (call .file.run.phpfpm.search_all_dirs (ARG1))
		  (call .file.run.phpfpm.write_all_sock_files (ARG1)))

	   (blockinherit .subj.all_macro_template)

	   (typeattribute typeattr)

	   (allow typeattr self (capability (kill setgid setuid)))
	   (allow typeattr self (process (getsched)))
	   (allow typeattr self create_unix_stream_stream_socket)
	   (allow typeattr self create_unix_dgram_socket)

	   (call data.read_file_files (typeattr))
	   (call data.search_file_dirs (typeattr))

	   (call exec.entrypoint_file_files (typeattr))
	   (call exec.mapexecute_file_files (typeattr))
	   (call exec.read_file_files (typeattr))

	   (call .exec.execute_file_files (typeattr))

	   (call .cert.read_file_pattern.type (typeattr))

	   (call .cpu.read_sysfile_pattern.type (typeattr))

	   (call .crypto.read_sysctlfile_pattern.type (typeattr))

	   (call .cryptopol.conf.read_file_files (typeattr))
	   (call .cryptopol.conf.traverse_file_pattern.type (typeattr))

	   (call .cryptopol.data.read_file_files (typeattr))
	   (call .cryptopol.data.search_file_pattern.type (typeattr))

	   (call .gcrypt.conf.read_file_pattern.type (typeattr))

	   (call .kernel.read_sysctlfile_pattern.type (typeattr))

	   (call .locale.data.map_file_pattern.type (typeattr))
	   (call .locale.data.read_file_pattern.type (typeattr))

	   (call .nss.passwdgroup.type (typeattr))

	   (call .php.conf.list_file_dirs (typeattr))
	   (call .php.conf.read_file_files (typeattr))
	   (call .php.conf.read_file_lnk_files (typeattr))

	   (call .php.state.search_file_dirs (typeattr))

	   (call .random.read_nodedev_chr_files (typeattr))

	   (call .random.read_sysctlfile_pattern.type (typeattr))

	   (call .run.deletename_file_dirs (typeattr))

	   (call .shell.exec.execute_file_files (typeattr))

	   (call .selinux.linked.type (typeattr))

	   (call .state.search_file_pattern.type (typeattr))

	   (call .sys.agent.type (typeattr))

	   (call .systemd.journal.relay_msgs.type (typeattr))

	   (call .systemd.notify.type (typeattr))

	   (call .tmp.deletename_file_dirs (typeattr))

	   (block template

		  (macro unix_stream_connect ((type ARG1))
			 (call connectto_subj_unix_stream_sockets (ARG1))
			 (call run.search_file_dirs (ARG1))
			 (call run.write_file_sock_files (ARG1)))

		  (blockinherit .subj.common.template)

		  (call conf.list_file_dirs (subj))
		  (call conf.read_file_files (subj))
		  (call conf.read_file_lnk_files (subj))

		  (call log.append_file_files (subj))
		  (call log.create_file_files (subj))
		  (call log.delete_file_files (subj))
		  (call log.manage_file_dirs (subj))
		  (call log.read_file_files (subj))
		  (call log.rename_file_files (subj))
		  (call log.setattr_file_files (subj))

		  (call run.manage_file_dirs (subj))
		  (call run.manage_file_files (subj))
		  (call run.manage_file_sock_files (subj))

		  (call state.manage_file_dirs (subj))
		  (call state.manage_file_files (subj))

		  (call tmp.manage_file_files (subj))
		  (call tmp.map_file_files (subj))
		  (call tmp.tmp_file_type_transition_file (subj))

		  (call .phpfpm.instance.type (subj))

		  (block conf

			 (blockinherit .file.conf.phpfpm.template))

		  (block log

			 (macro setattr_file_files ((type ARG1))
				(allow ARG1 file (file (setattr))))

			 (blockinherit .file.log.phpfpm.template))

		  (block run

			 (blockinherit .file.run.phpfpm.template))

		  (block state

			 (blockinherit .file.state.php.phpfpm.template))

		  (block tmp

			 (blockinherit .file.tmp.phpfpm.template))

		  (block unit

			 (blockinherit .file.unit.phpfpm.template))))

    (block log

	   (filecon "/var/log/php-fpm" dir file_context)
	   (filecon "/var/log/php-fpm/.*" any file_context)

	   (macro log_file_type_transition_file ((type ARG1))
		  (call .log.file_type_transition
			(ARG1 file dir "php-fpm"))))

    (block run

	   (filecon "/run/php-fpm" dir file_context)
	   (filecon "/run/php-fpm/.*" any file_context)

	   (macro run_file_type_transition_file ((type ARG1))
		  (call .run.file_type_transition
			(ARG1 file dir "php-fpm"))))

    (block state

	   (filecon "/var/lib/php/opcache" dir file_context)
	   (filecon "/var/lib/php/opcache/.*" any file_context)
	   (filecon "/var/lib/php/session" dir file_context)
	   (filecon "/var/lib/php/session/.*" any file_context)
	   (filecon "/var/lib/php/wsdlcache" dir file_context)
	   (filecon "/var/lib/php/wsdlcache/.*" any file_context)

	   (macro php_state_file_type_transition_file ((type ARG1))
		  (call .php.state.file_type_transition
			(ARG1 file dir "opcache"))
		  (call .php.state.file_type_transition
			(ARG1 file dir "session"))
		  (call .php.state.file_type_transition
			(ARG1 file dir "wsdlcache"))))

    (block unit

	   (filecon "/usr/lib/systemd/system/php-fpm\.service.*" file
		    file_context)))
