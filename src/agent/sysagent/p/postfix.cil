;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(block postfix

       (blockinherit .sys.agent.template)

       (allow subj self (capability (chown dac_read_search fowner)))
       (allow subj self (tcp_socket (create)))

       (call cli.signal_subj_processes (subj))
       (call cli.subj_type_transition (subj))

       (call common.exec.getattr_all_files (subj))
       (call common.type (subj))

       (call conf.setattr_file_dirs (subj))

       (call master.readwrite_subj_unix_stream_sockets (subj))
       (call master.signal_subj_processes (subj))
       (call master.subj_type_transition (subj))

       (call pid.spool.read_file_files (subj))

       (call sendmail.exec.read_file_files (subj))

       (call state.list_file_dirs (subj))
       (call state.read_file_files (subj))
       (call state.setattr_file_dirs (subj))

       (call .cgroup.getattr_fs_pattern.type (subj))

       (call .cmdline.read_procfile_pattern.type (subj))

       (call .data.getattr_file_files (subj))

       (call .exec.dontaudit_setattr_file_dirs (subj))
       (call .exec.execute_file_files (subj))
       (call .exec.list_file_dirs (subj))

       (call .file.spool.postfix.getattr_all_files (subj))
       (call .file.spool.postfix.list_all_dirs (subj))
       (call .file.spool.postfix.setattr_all_dirs (subj))

       (call .man.data.getattr_file_files (subj))
       (call .man.data.search_file_dirs (subj))

       (call .nss.hosts.type (subj))
       (call .nss.passwdgroup.type (subj))

       (call .rbacsep.constrained.type (subj))
       (call .rbacsep.usefdsource.type (subj))

       (call .shell.exec.execute_file_files (subj))

       (call .terminfo.read_file_pattern.type (subj))

       (call .xattr.getattr_fs_pattern.type (subj))

       (block active

	      (block spool

		     (filecon "/var/spool/postfix/active" dir file_context)
		     (filecon "/var/spool/postfix/active/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "active")))

		     (blockinherit .file.spool.postfix.template)))

       (block aliasdb

	      (blockinherit .sys.agent.template)

	      (call cli.signal_subj_processes (subj))
	      (call cli.subj_type_transition (subj))

	      (call common.type (subj))

	      (call sendmail.signal_subj_processes (subj))
	      (call sendmail.subj_type_transition (subj))

	      (call state.manage_file_files (subj))
	      (call state.state_file_type_transition_file (subj file "*"))

	      (call .aliases.read_file_files (subj))

	      (call .exec.execute_file_files (subj))

	      (call .nss.passwdgroup.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .shell.exec.mapexecute_file_files (subj))
	      (call .shell.exec.read_file_files (subj))

	      (call .state.deletename_file_dirs (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/aliasesdb" file file_context)

		     (call common.exec.type (file))))

       (block anvil

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (optional postfix_anvil_dovecot
			(call .dovecot.connectto_subj_unix_stream_sockets
			      (subj)))

	      (block exec

		     (filecon "/usr/bin/postfix/anvil" file file_context)))

       (block bounce

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call defer.spool.manage_file_dirs (subj))
	      (call defer.spool.manage_file_files (subj))

	      (call incoming.spool.readwrite_file_files (subj))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_public (subj))

	      (call spool.manage_file_files (subj))
	      (call spool.readwrite_file_dirs (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/bounce" file file_context))

	      (block spool

		     (filecon "/var/spool/postfix/bounce" dir file_context)
		     (filecon "/var/spool/postfix/bounce/.*" any ())

		     (macro getattr_file_files ((type ARG1))
			    (allow ARG1 file (file (getattr))))

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "bounce")))

		     (blockinherit .file.spool.postfix.template)))

       (block cert

	      (filecon "/etc/pki/postfix" dir file_context)
	      (filecon "/etc/pki/postfix/.*" any file_context)

	      (macro cert_file_type_transition_file ((type ARG1))
		     (call .cert.file_type_transition
			   (ARG1 file dir "postfix")))

	      (macro getattr_file_files ((type ARG1))
		     (allow ARG1 file (file (getattr))))

	      (macro setattr_file_dirs ((type ARG1))
		     (allow ARG1 file (dir (setattr))))

	      (blockinherit .file.cert.template))

       (block chrootupdate

	      (blockinherit .sys.agent.template)

	      (call common.type (subj))

	      (call .nss.passwdgroup.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .shell.exec.mapexecute_file_files (subj))
	      (call .shell.exec.read_file_files (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/chroot-update" file
			      file_context)

		     (call common.exec.type (file))))

       (block cleanup

	      (blockinherit .agent.template)

	      (allow subj self create_tcp_socket)

	      (call hold.spool.addname_file_dirs (subj))

	      (call incoming.spool.manage_file_files (subj))
	      (call incoming.spool.readwrite_file_dirs (subj))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_private (subj))
	      (call master.unix_stream_connect_public (subj))

	      (call smtpd.readwrite_subj_tcp_sockets (subj))
	      (call smtpd.readwrite_subj_unix_stream_sockets (subj))
	      (call smtpd.use_subj_fds (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (optional postfix_cleanup_opendkimunreservedport
			(call .opendkim.nameconnect_port_tcp_sockets (subj)))

	      (block exec

		     (filecon "/usr/bin/postfix/cleanup" file file_context)))

       (block cli

	      (blockinherit .hybrid.agent.template)

	      (allow subj self (capability (setgid setuid)))
	      (allow subj self create_tcp_socket)

	      (call active.spool.deletename_file_dirs (subj))

	      (call common.type (subj))

	      (call conf.manage_file_files (subj))
	      (call conf.readwrite_file_dirs (subj))

	      (call defer.spool.delete_file_files (subj))
	      (call defer.spool.deletename_file_dirs (subj))

	      (call deferred.spool.deletename_file_dirs (subj))

	      (call hold.spool.delete_file_files (subj))
	      (call hold.spool.deletename_file_dirs (subj))

	      (call incoming.spool.delete_file_files (subj))
	      (call incoming.spool.deletename_file_dirs (subj))

	      (call maildrop.spool.manage_file_files (subj))
	      (call maildrop.spool.readwrite_file_dirs (subj))

	      (call master.readwrite_subj_unix_stream_sockets (subj))
	      (call master.unix_stream_connect_public (subj))

	      (call pipe.readwriteinherited_subj_fifo_files (subj))
	      (call pipe.use_subj_fds (subj))

	      (call sendmail.readwrite_subj_unix_stream_sockets (subj))
	      (call sendmail.use_subj_fds (subj))

	      (call sendmail.mailer.writeinherited_all_fifo_files (subj))
	      (call sendmail.mailer.use_all_fds (subj))

	      (call .aliases.manage_file_files (subj))
	      (call .aliases.conf_file_type_transition_file (subj "*"))

	      (call .cert.read_file_files (subj))
	      (call .cert.traverse_file_pattern.type (subj))

	      (call .cryptopol.conf.read_file_files (subj))
	      (call .cryptopol.conf.traverse_file_pattern.type (subj))

	      (call .cryptopol.data.read_file_files (subj))
	      (call .cryptopol.data.search_file_pattern.type (subj))

	      (call .file.spool.postfix.getattr_all_files (subj))
	      (call .file.spool.postfix.list_all_dirs (subj))

	      (call .nss.hosts.type (subj))
	      (call .nss.passwdgroup.type (subj))
	      (call .nss.services.type (subj))

	      (call .smtp.msa.nameconnect_port_tcp_sockets (subj))
	      (call .smtp.nameconnect_port_tcp_sockets (subj))

	      (optional postfix_cli_dovecot
			(call .dovecot.readwriteinherited_subj_fifo_files
			      (subj))
			(call .dovecot.use_subj_fds (subj)))

	      (block exec

		     (filecon "/usr/bin/postalias" file file_context)
		     (filecon "/usr/bin/postcat" file file_context)
		     (filecon "/usr/bin/postconf" file file_context)
		     (filecon "/usr/bin/postdrop" file file_context)
		     (filecon "/usr/bin/postkick" file file_context)
		     (filecon "/usr/bin/postlock" file file_context)
		     (filecon "/usr/bin/postlog" file file_context)
		     (filecon "/usr/bin/postmap" file file_context)
		     (filecon "/usr/bin/postmulti" file file_context)
		     (filecon "/usr/bin/postqueue" file file_context)
		     (filecon "/usr/bin/postsuper" file file_context)
		     (filecon "/usr/bin/posttls-finger" file file_context)
		     (filecon "/usr/bin/smtp-sink" file file_context)
		     (filecon "/usr/bin/smtp-source" file file_context)

		     (call common.exec.type (file))))

       (block common

	      (macro type ((type ARG1))
		     (typeattributeset typeattr ARG1))

	      (typeattribute typeattr)

	      (allow typeattr self (process (getsched setrlimit setsched)))
	      (allow typeattr self create_unix_dgram_socket)

	      (call conf.list_file_dirs (typeattr))
	      (call conf.read_file_files (typeattr))

	      (call .cpu.read_sysfile_files (typeattr))
	      (call .cpu.search_sysfile_pattern.type (typeattr))

	      (call .crypto.read_sysctlfile_pattern.type (typeattr))

	      (call .file.spool.postfix.search_all_dirs (typeattr))

	      (call .kernel.read_sysctlfile_pattern.type (typeattr))

	      (call .lib.list_file_dirs (typeattr))

	      (call .locale.data.map_file_pattern.type (typeattr))
	      (call .locale.data.read_file_pattern.type (typeattr))

	      (call .net.read_procfile_pattern.type (typeattr))

	      (call .random.read_sysctlfile_pattern.type (typeattr))

	      (call .selinux.linked.type (typeattr))

	      (call .spool.search_file_pattern.type (typeattr))

	      (call .state.search_file_pattern.type (typeattr))

	      (call .systemd.journal.relay_msgs.type (typeattr))

	      (call .tmp.getattr_file_dirs (typeattr))

	      (block exec

		     (macro getattr_all_files ((type ARG1))
			    (allow ARG1 typeattr (file (getattr))))

		     (macro type ((type ARG1))
			    (typeattributeset typeattr ARG1))

		     (typeattribute typeattr)))

       (block conf

	      (filecon "/etc/postfix" dir file_context)
	      (filecon "/etc/postfix/.*" any file_context)

	      (macro conf_file_type_transition_file ((type ARG1))
		     (call .conf.file_type_transition
			   (ARG1 file dir "postfix")))

	      (macro setattr_file_dirs ((type ARG1))
		     (allow ARG1 file (dir (setattr))))

	      (blockinherit .file.conf.template))

       (block corrupt

	      (block spool

		     (filecon "/var/spool/postfix/corrupt" dir file_context)
		     (filecon "/var/spool/postfix/corrupt/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "corrupt")))

		     (blockinherit .file.spool.postfix.template)))

       (block defer

	      (block spool

		     (filecon "/var/spool/postfix/defer" dir file_context)
		     (filecon "/var/spool/postfix/defer/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "defer")))

		     (blockinherit .file.spool.postfix.template)))

       (block deferred

	      (block spool

		     (filecon "/var/spool/postfix/deferred" dir file_context)
		     (filecon "/var/spool/postfix/deferred/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "deferred")))

		     (macro setattr_file_files ((type ARG1))
			    (allow ARG1 file (file (setattr))))

		     (blockinherit .file.spool.postfix.template)))

       (block discard

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/discard" file file_context)))

       (block dnsblog

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/dnsblog" file file_context)))

       (block error

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call incoming.spool.readwrite_file_files (subj))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_private (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/error" file file_context)))

       (block exec

	      (filecon "/usr/bin/postfix" file file_context))

       (block flush

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/flush" file file_context))

	      (block spool

		     (filecon "/var/spool/postfix/flush" dir file_context)
		     (filecon "/var/spool/postfix/flush/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "flush")))

		     (blockinherit .file.spool.postfix.template)))

       (block hold

	      (block spool

		     (filecon "/var/spool/postfix/hold" dir file_context)
		     (filecon "/var/spool/postfix/hold/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "hold")))

		     (blockinherit .file.spool.postfix.template)))

       (block incoming

	      (block spool

		     (filecon "/var/spool/postfix/incoming" dir file_context)
		     (filecon "/var/spool/postfix/incoming/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "incoming")))

		     (blockinherit .file.spool.postfix.template)))

       (block local

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call incoming.spool.readwrite_file_files (subj))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_private (subj))
	      (call master.unix_stream_connect_public (subj))

	      (call spool.manage_file_files (subj))
	      (call spool.mail_file_type_transition_file (subj "*"))

	      (call .aliases.read_file_files (subj))

	      (call .mail.deletename_file_dirs (subj))

	      (call .nss.services.type (subj))

	      (call .user.home.search_file_pattern.type (subj))

	      (call .user.mail.append_file_files (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/local" file file_context))

	      (block spool

		     (filecon "/var/spool/mail/*.\.lock" file file_context)
		     (filecon "/var/spool/mail/*.\.lock\..*" file file_context)

		     (macro mail_file_type_transition_file
			    ((type ARG1)(name ARG2))
			    (call .mail.file_type_transition
				  (ARG1 file file ARG2)))

		     (blockinherit .file.macro_template_files)
		     (blockinherit .file.spool.postfix.base_template)))

       (block maildrop

	      (block spool

		     (filecon "/var/spool/postfix/maildrop" dir file_context)
		     (filecon "/var/spool/postfix/maildrop/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "maildrop")))

		     (blockinherit .file.spool.postfix.template)

		     (call .rbacsep.exempt.obj.type (file))))

       (block master

	      (macro agent ((type ARG1)(type ARG2))
		     (typetransition subj ARG2 process ARG1)
		     (call service.exec.type (ARG2))
		     (call service.type (ARG1)))

	      (macro accept_subj_tcp_sockets ((type ARG1))
		     (allow ARG1 subj (tcp_socket (accept))))

	      (macro accept_subj_unix_stream_sockets ((type ARG1))
		     (allow ARG1 subj (unix_stream_socket (accept))))

	      (macro readwrite_subj_tcp_sockets ((type ARG1))
		     (allow ARG1 subj readwrite_tcp_socket))

	      (macro unix_stream_connect_private ((type ARG1))
		     (call connectto_subj_unix_stream_sockets (ARG1))
		     (call private.spool.search_file_dirs (ARG1))
		     (call private.spool.write_file_sock_files (ARG1)))

	      (macro unix_stream_connect_public ((type ARG1))
		     (call connectto_subj_unix_stream_sockets (ARG1))
		     (call public.spool.search_file_dirs (ARG1))
		     (call public.spool.write_file_sock_files (ARG1)))

	      (blockinherit .agent.template)

	      (allow subj self
		     (capability (dac_read_search kill net_bind_service setgid
						  setuid)))
	      (allow subj self create_tcp_stream_socket)
	      (allow subj self (unix_stream_socket (accept connectto listen)))

	      (call service.exec.mapexecute_all_files (subj))
	      (call service.exec.read_all_files (subj))

	      (call service.signal_all_processes (subj))
	      (call service.transition_all_processes (subj))

	      (call common.type (subj))

	      (call pid.spool.manage_file_files (subj))
	      (call pid.spool.readwrite_file_dirs (subj))

	      (call private.spool.manage_file_sock_files (subj))
	      (call private.spool.readwrite_file_dirs (subj))

	      (call public.spool.manage_file_sock_files (subj))
	      (call public.spool.readwrite_file_dirs (subj))

	      (call spawn.subj_type_transition (subj))

	      (call state.manage_file_files (subj))
	      (call state.readwrite_file_dirs (subj))

	      (call .net.nodebind_netnode_tcp_sockets (subj))

	      (call .nss.hosts.type (subj))
	      (call .nss.passwdgroup.type (subj))
	      (call .nss.services.type (subj))

	      (call .rbacsep.exempttarget.type (subj))
	      (call .rbacsep.usefdtarget.type (subj))

	      (call .smtp.namebind_port_tcp_sockets (subj))
	      (call .smtp.msa.namebind_port_tcp_sockets (subj))

	      (call .sys.agent.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/master" file file_context)

		     (call common.exec.type (file))

		     (call .sys.agent.exec.type (file)))

	      (block service

		     (macro signal_all_processes ((type ARG1))
			    (allow ARG1 typeattr (process (signal))))

		     (macro transition_all_processes ((type ARG1))
			    (allow ARG1 typeattr (process (transition))))

		     (macro type ((type ARG1))
			    (typeattributeset typeattr ARG1))

		     (typeattribute typeattr)

		     (allow typeattr self
			    (capability (dac_read_search setgid setuid)))

		     (call common.type (typeattr))

		     (call master.accept_subj_unix_stream_sockets (typeattr))
		     (call master.readwrite_subj_unix_stream_sockets (typeattr))
		     (call master.readwriteinherited_subj_fifo_files (typeattr))
		     (call master.sigchld_subj_processes (typeattr))
		     (call master.use_subj_fds (typeattr))

		     (call pid.spool.manage_file_files (typeattr))
		     (call pid.spool.readwrite_file_dirs (typeattr))

		     (call .nss.hosts.type (typeattr))
		     (call .nss.passwdgroup.type (typeattr))

		     (call .sys.agent.type (typeattr))

		     (block exec

			    (macro mapexecute_all_files ((type ARG1))
				   (allow ARG1 typeattr mapexecute_file))

			    (macro read_all_files ((type ARG1))
				   (allow ARG1 typeattr read_file))

			    (macro type ((type ARG1))
				   (typeattributeset typeattr ARG1))

			    (typeattribute typeattr)

			    (call common.exec.type (typeattr))

			    (call .sys.agent.exec.type (typeattr)))))

       (block oqmgr

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/oqmgr" file file_context)))

       (block pickup

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call maildrop.spool.delete_file_files (subj))
	      (call maildrop.spool.deletename_file_dirs (subj))
	      (call maildrop.spool.read_file_files (subj))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_public (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/pickup" file file_context)))

       (block pid

	      (block spool

		     (filecon "/var/spool/postfix/pid" dir file_context)
		     (filecon "/var/spool/postfix/pid/.*" any file_context)

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "pid")))

		     (blockinherit .file.spool.postfix.template)))

       (block pipe

	      (blockinherit .agent.template)

	      (call incoming.spool.readwrite_file_files (subj))

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/pipe" file file_context)))

       (block postscreen

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/postscreen" file file_context)))

       (block private

	      (block spool

		     (filecon "/var/spool/postfix/private" dir file_context)
		     (filecon "/var/spool/postfix/private/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "private")))

		     (blockinherit .file.macro_template_dirs)
		     (blockinherit .file.macro_template_sock_files)
		     (blockinherit .file.spool.postfix.base_template)))

       (block proxymap

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/proxymap" file file_context)))

       (block public

	      (block spool

		     (filecon "/var/spool/postfix/public" dir file_context)
		     (filecon "/var/spool/postfix/public/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "public")))

		     (blockinherit .file.macro_template_dirs)
		     (blockinherit .file.macro_template_sock_files)
		     (blockinherit .file.spool.postfix.base_template)

		     (call .rbacsep.exempt.obj.type (file))))

       (block qmgr

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call active.spool.delete_file_files (subj))
	      (call active.spool.readwrite_file_dirs (subj))

	      (call bounce.spool.getattr_file_files (subj))

	      (call defer.spool.delete_file_files (subj))
	      (call defer.spool.deletename_file_dirs (subj))

	      (call deferred.spool.manage_file_dirs (subj))
	      (call deferred.spool.setattr_file_files (subj))

	      (call incoming.spool.manage_file_files (subj))
	      (call incoming.spool.readwrite_file_dirs (subj))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_private (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/nqmgr" file file_context)
		     (filecon "/usr/bin/postfix/qmgr" file file_context)))

       (block qmqpd

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/qmqpd" file file_context)))

       (block rmail

	      (blockinherit .user.agent.template)

	      (block exec

		     (filecon "/usr/bin/rmail\.postfix" file file_context)))

       (block saved

	      (block spool

		     (filecon "/var/spool/postfix/saved" dir file_context)
		     (filecon "/var/spool/postfix/saved/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "saved")))

		     (blockinherit .file.spool.postfix.template)))

       (block scache

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call master.agent (subj exec.file))

	      (call smtp.readwrite_subj_tcp_sockets (subj))
	      (call smtp.readwrite_subj_unix_stream_sockets (subj))
	      (call smtp.use_subj_fds (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/scache" file file_context)))

       (block sendmail

	      (blockinherit .hybrid.agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call cli.signal_subj_processes (subj))
	      (call cli.subj_type_transition (subj))

	      (call common.type (subj))

	      (call mailer.readwrite_all_unix_stream_sockets (subj))
	      (call mailer.use_all_fds (subj))

	      (call mailer.tmp.readwriteinherited_all_files (subj))

	      (call master.readwriteinherited_subj_fifo_files (subj))
	      (call master.use_subj_fds (subj))

	      (call pipe.readwriteinherited_subj_fifo_files (subj))
	      (call pipe.use_subj_fds (subj))

	      (call .nss.hosts.type (subj))
	      (call .nss.passwdgroup.type (subj))

	      (call .rbacsep.exemptsource.type (subj))

	      (call .sys.home.list_file_dirs (subj))

	      (optional postfix_sendmail_dovecot
			(call .dovecot.readwrite_subj_unix_stream_sockets
			      (subj))
			(call .dovecot.readwriteinherited_subj_fifo_files
			      (subj))
			(call .dovecot.spool.readwriteinherited_file_files
			      (subj))
			(call .dovecot.use_subj_fds (subj)))

	      (block exec

		     (macro auditexecuteaccess_file_files ((type ARG1))
			    (allow ARG1 file (file (getattr execute))))

		     (filecon "/usr/bin/sendmail\.postfix" file file_context)

		     (call common.exec.type (file)))

	      (block mailer

		     (macro readwrite_all_unix_stream_sockets ((type ARG1))
			    (allow ARG1 typeattr readwrite_unix_stream_socket))

		     (macro role ((role ARG1))
			    (roleattributeset roleattr ARG1))

		     (macro type ((type ARG1))
			    (typeattributeset typeattr ARG1))

		     (macro use_all_fds ((type ARG1))
			    (allow ARG1 typeattr (fd (use))))

		     (macro writeinherited_all_fifo_files ((type ARG1))
			    (allow ARG1 typeattr writeinherited_fifo_file))

		     (roleattribute roleattr)
		     (typeattribute typeattr)

		     (call cli.role (roleattr))

		     (call sendmail.signal_subj_processes (typeattr))
		     (call sendmail.subj_type_transition (typeattr))

		     (call sendmail.role (roleattr))

		     (block tmp

			    (macro readwriteinherited_all_files ((type ARG1))
				   (allow ARG1 typeattr
					  readwriteinherited_file))

			    (macro type ((type ARG1))
				   (typeattributeset typeattr ARG1))

			    (typeattribute typeattr))))

       (block showq

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call master.agent (subj exec.file))

	      (call .file.spool.postfix.list_all_dirs (subj))
	      (call .file.spool.postfix.read_all_files (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/showq" file file_context)))

       (block smtp

	      (macro readwrite_subj_tcp_sockets ((type ARG1))
		     (allow ARG1 subj readwrite_tcp_socket))

	      (blockinherit .agent.template)

	      (allow subj self create_tcp_socket)

	      (call incoming.spool.readwrite_file_files (subj))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_private (subj))

	      (call .nss.services.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .smtp.nameconnect_port_tcp_sockets (subj))

	      (optional postfix_smtp_dovecot
			(call .dovecot.connectto_subj_unix_stream_sockets
			      (subj)))

	      (block exec

		     (filecon "/usr/bin/postfix/lmtp" file file_context)
		     (filecon "/usr/bin/postfix/smtp" file file_context)))

       (block smtpd

	      (macro readwrite_subj_tcp_sockets ((type ARG1))
		     (allow ARG1 subj readwrite_tcp_socket))

	      (blockinherit .agent.template)

	      (allow subj self create_tcp_socket)

	      (call cert.list_file_dirs (subj))
	      (call cert.read_file_files (subj))

	      (call master.agent (subj exec.file))
	      (call master.accept_subj_tcp_sockets (subj))
	      (call master.readwrite_subj_tcp_sockets (subj))
	      (call master.unix_stream_connect_private (subj))
	      (call master.unix_stream_connect_public (subj))

	      (call .aliases.read_file_files (subj))

	      (call .cert.read_file_files (subj))
	      (call .cert.traverse_file_pattern.type (subj))

	      (call .crypto.read_sysctlfile_pattern.type (subj))

	      (call .cryptopol.conf.read_file_files (subj))
	      (call .cryptopol.conf.traverse_file_pattern.type (subj))

	      (call .cryptopol.data.read_file_files (subj))
	      (call .cryptopol.data.search_file_pattern.type (subj))

	      (call .gcrypt.conf.read_file_pattern.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .xattr.getattr_fs_pattern.type (subj))

	      (optional postfix_smtpd_certbot
			(call .certbot.conf.read_file_pattern.type (subj)))

	      (optional postfix_smtpd_dovecot
			(call .dovecot.connectto_subj_unix_stream_sockets
			      (subj)))

	      (optional postfix_smtpd_opendkimunreservedport
			(call .opendkim.nameconnect_port_tcp_sockets (subj)))

	      (block exec

		     (filecon "/usr/bin/postfix/smtpd" file file_context)))

       (block spawn

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/spawn" file file_context)))

       (block spool

	      (filecon "/var/spool/postfix" dir file_context)
	      (filecon "/var/spool/postfix/.*" any file_context)

	      (macro spool_file_type_transition_file ((type ARG1))
		     (call .spool.file_type_transition
			   (ARG1 file dir "postfix")))

	      (blockinherit .file.spool.postfix.template))

       (block state

	      (filecon "/var/lib/misc/postfix\.aliasesdb-stamp" file
		       file_context)
	      (filecon "/var/lib/misc/postfix\.aliasesdb-stamp\..*" file
		       file_context)

	      (filecon "/var/lib/postfix" dir file_context)
	      (filecon "/var/lib/postfix/.*" any file_context)

	      (macro setattr_file_dirs ((type ARG1))
		     (allow ARG1 file (dir (setattr))))

	      (macro state_file_type_transition_file
		     ((type ARG1)(class ARG2)(name ARG3))
		     (call .state.file_type_transition
			   (ARG1 file ARG2 ARG3)))

	      (blockinherit .file.macro_template_dirs)
	      (blockinherit .file.macro_template_files)
	      (blockinherit .file.state.base_template))

       (block tlsmgr

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call master.agent (subj exec.file))

	      (call state.manage_file_files (subj))
	      (call state.readwrite_file_dirs (subj))

	      (call .random.read_nodedev_chr_files (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/tlsmgr" file file_context)))

       (block tlsproxy

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/tlsproxy" file file_context)))

       (block trace

	      (block spool

		     (filecon "/var/spool/postfix/trace" dir file_context)
		     (filecon "/var/spool/postfix/trace/.*" any ())

		     (macro postfix_spool_file_type_transition_file
			    ((type ARG1))
			    (call .postfix.spool.file_type_transition
				  (ARG1 file dir "trace")))

		     (blockinherit .file.spool.postfix.template)))

       (block trivialrewrite

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/trivial-rewrite" file
			      file_context)))

       (block unit

	      (filecon "/usr/lib/systemd/system/postfix\.service.*" file
		       file_context)
	      (filecon "/usr/lib/systemd/system/postfix@.*\.service.*" file
		       file_context)

	      (blockinherit .file.unit.template))

       (block verify

	      (blockinherit .agent.template)

	      (allow subj self (tcp_socket (create)))

	      (call master.agent (subj exec.file))
	      (call master.unix_stream_connect_private (subj))
	      (call master.unix_stream_connect_public (subj))

	      (call state.manage_file_files (subj))
	      (call state.readwrite_file_dirs (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/verify" file file_context)))

       (block virtual

	      (blockinherit .agent.template)

	      (call master.agent (subj exec.file))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/postfix/virtual" file file_context))))

(in file.spool

    (block postfix

	   (macro getattr_all_files ((type ARG1))
		  (allow ARG1 typeattr (file (getattr))))

	   (macro setattr_all_dirs ((type ARG1))
		  (allow ARG1 typeattr (dir (setattr))))

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)
	   (blockinherit file.all_macro_template_lnk_files)

	   (typeattribute typeattr)

	   (call file.spool.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.spool.base_template)

		  (call .file.spool.postfix.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.spool.postfix.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files))))

(in file.unconfined

    (call .postfix.active.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.bounce.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.cert.cert_file_type_transition_file (typeattr))
    (call .postfix.conf.conf_file_type_transition_file (typeattr))
    (call .postfix.corrupt.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.defer.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.deferred.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.flush.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.hold.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.incoming.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.maildrop.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.pid.spool.postfix_spool_file_type_transition_file (typeattr))
    (call .postfix.private.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.public.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.saved.spool.postfix_spool_file_type_transition_file
	  (typeattr))
    (call .postfix.spool.spool_file_type_transition_file (typeattr))
    (call .postfix.state.state_file_type_transition_file
	  (typeattr dir "postfix"))
    (call .postfix.state.state_file_type_transition_file
	  (typeattr file "postfix.aliasesdb-stamp"))
    (call .postfix.trace.spool.postfix_spool_file_type_transition_file
	  (typeattr)))

(in sudo

    (call .postfix.sendmail.mailer.type (subj))
    (call .postfix.sendmail.mailer.role (roleattr)))

(in sys.tmp

    (call .postfix.sendmail.mailer.tmp.type (file)))

(in user

    (call .postfix.rmail.role (role))

    (call .postfix.sendmail.mailer.type (subj))
    (call .postfix.sendmail.mailer.role (role)))

(in user.tmp

    (call .postfix.sendmail.mailer.tmp.type (file)))

(in wheel

    (call .postfix.rmail.role (role))

    (call .postfix.sendmail.mailer.role (role)))
