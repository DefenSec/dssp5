;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(block httpd

       (macro accept_subj_unix_stream_sockets ((type ARG1))
	      (allow ARG1 subj (unix_stream_socket (accept))))

       (blockinherit .sys.agent.template)

       (allow subj self (capability (chown dac_override dac_read_search kill
					   net_admin net_bind_service setgid
					   setuid)))
       (allow subj self (process (getpgid getsched)))
       (allow subj self create_tcp_stream_socket)
       (allow subj self create_sem)
       (allow subj self create_shm)
       (allow subj self create_unix_dgram_socket)
       (allow subj self (unix_stream_socket (accept connectto listen)))

       (call cache.manage_file_dirs (subj))
       (call cache.manage_file_files (subj))

       (call cert.list_file_dirs (subj))
       (call cert.read_file_files (subj))

       (call conf.list_file_dirs (subj))
       (call conf.read_file_files (subj))
       (call conf.read_file_lnk_files (subj))

       (call data.list_file_dirs (subj))
       (call data.map_file_files (subj))
       (call data.read_file_files (subj))
       (call data.read_file_lnk_files (subj))

       (call log.append_file_files (subj))
       (call log.create_file_files (subj))
       (call log.delete_file_files (subj))
       (call log.read_file_files (subj))
       (call log.readwrite_file_dirs (subj))
       (call log.rename_file_files (subj))
       (call log.setattr_file_files (subj))

       (call rotatelogs.signal_subj_processes (subj))
       (call rotatelogs.subj_type_transition (subj))

       (call run.manage_file_dirs (subj))
       (call run.manage_file_files (subj))
       (call run.manage_file_sock_files (subj))
       (call run.run_file_type_transition_file (subj))

       (call state.manage_file_dirs (subj))
       (call state.manage_file_files (subj))

       (call suexec.signal_subj_processes (subj))
       (call suexec.subj_type_transition (subj))

       (call tmp.manage_file_files (subj))
       (call tmp.tmp_file_type_transition_file (subj))

       (call .cache.search_file_pattern.type (subj))

       (call .cert.read_file_files (subj))
       (call .cert.traverse_file_pattern.type (subj))

       (call .ci.getattr_fs_pattern.type (subj))
       (call .ci.manage_fs_pattern.type (subj))

       (call .cpu.read_sysfile_files (subj))
       (call .cpu.search_sysfile_pattern.type (subj))

       (call .cpuinfo.read_procfile_files (subj))

       (call .crypto.read_sysctlfile_pattern.type (subj))

       (call .cryptopol.conf.read_file_files (subj))
       (call .cryptopol.conf.traverse_file_pattern.type (subj))

       (call .cryptopol.data.read_file_files (subj))
       (call .cryptopol.data.search_file_pattern.type (subj))

       (call .exec.mapexecute_file_files (subj))
       (call .exec.read_file_files (subj))

       ;; /usr/share/testpage
       (call .data.dontaudit_read_file_lnk_files (subj))

       (call .dos.getattr_fs_pattern.type (subj))
       (call .dos.manage_fs_pattern.type (subj))

       (call .fuse.getattr_fs_pattern.type (subj))
       (call .fuse.manage_fs_pattern.type (subj))

       (call .gcrypt.conf.read_file_pattern.type (subj))

       (call .http.namebind_port_tcp_sockets (subj))
       (call .http.https.namebind_port_tcp_sockets (subj))

       (call .kernel.read_sysctlfile_pattern.type (subj))

       (call .locale.data.map_file_pattern.type (subj))
       (call .locale.data.read_file_pattern.type (subj))

       (call .log.search_file_pattern.type (subj))

       (call .mime.read_file_pattern.type (subj))

       (call .net.nodebind_netnode_tcp_sockets (subj))

       (call .net.read_procfile_pattern.type (subj))

       (call .nfs.getattr_fs_pattern.type (subj))
       (call .nfs.manage_fs_pattern.type (subj))

       (call .nss.hosts.type (subj))
       (call .nss.passwdgroup.type (subj))

       (call .overcommitmemory.read_sysctlfile_pattern.type (subj))

       (call .p11kit.conf.read_file_pattern.type (subj))

       (call .p11kit.data.map_file_files (subj))
       (call .p11kit.data.read_file_pattern.type (subj))

       (call .random.read_nodedev_chr_files (subj))

       (call .random.read_sysctlfile_pattern.type (subj))

       (call .selinux.linked.type (subj))
       (call .selinux.mapread_fs_pattern.type (subj))

       (call .shell.exec.mapexecute_file_files (subj))
       (call .shell.exec.read_file_files (subj))

       (call .state.search_file_pattern.type (subj))

       (call .systemd.journal.relay_msgs.type (subj))

       (call .systemd.notify.type (subj))

       (call .tmp.deletename_file_dirs (subj))

       (call .web.content.script.webserver.type (subj))

       (optional httpd_certbot
		 (call .certbot.conf.read_file_pattern.type (subj)))

       (optional httpd_phpfpm
		 (call .phpfpm.unix_stream_connect (subj)))

       (optional httpd_phpfpmunreservedport
		 (call .phpfpm.nameconnect_port_tcp_sockets (subj)))

       (block cache

	      (filecon "/var/cache/httpd" dir file_context)
	      (filecon "/var/cache/httpd/.*" any file_context)

	      (macro cache_file_type_transition_file ((type ARG1))
		     (call .cache.file_type_transition
			   (ARG1 file dir "httpd")))

	      (blockinherit .file.cache.base_template)
	      (blockinherit .file.macro_template_dirs)
	      (blockinherit .file.macro_template_files))

       (block cert

	      (filecon "/etc/pki/httpd" dir file_context)
	      (filecon "/etc/pki/httpd/.*" any file_context)

	      (macro cert_file_type_transition_file ((type ARG1))
		     (call .cert.file_type_transition
			   (ARG1 file dir "httpd")))

	      (blockinherit .file.cert.template))

       (block cli

	      (blockinherit .sys.agent.template)

	      (allow subj self (capability (chown dac_read_search)))
	      (allow subj self (process (setexec)))
	      (dontaudit subj self (capability (sys_resource)))

	      (call httpd.read_subj_states (subj))
	      (call httpd.signal_subj_processes (subj))
	      (call httpd.subj_type_transition (subj))

	      (call httpd.conf.list_file_dirs (subj))
	      (call httpd.conf.read_file_files (subj))
	      (call httpd.conf.read_file_lnk_files (subj))

	      (call httpd.log.search_file_dirs (subj))

	      (call httpd.run.manage_file_dirs (subj))
	      (call httpd.run.read_file_files (subj))
	      (call httpd.run.run_file_type_transition_file (subj))

	      (call tmp.manage_file_files (subj))
	      (call tmp.tmp_file_type_transition_file (subj))

	      (call .dev.list_file_pattern.type (subj))

	      (call .devpts.search_fs_pattern.type (subj))

	      (call .log.search_file_pattern.type (subj))

	      (call .nss.passwdgroup.type (subj))

	      (call .polkit.ttyagent.subj_type_transition (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .shell.exec.mapexecute_file_files (subj))
	      (call .shell.exec.read_file_files (subj))

	      (call .systemd.askpassword.client.type (subj))

	      (call .systemd.systemctl.exec.execute_file_files (subj))

	      (call .terminfo.read_file_pattern.type (subj))

	      (call .tmp.deletename_file_dirs (subj))

	      (block exec

		     (filecon "/usr/bin/apachectl" file file_context))

	      (block tmp

		     (macro tmp_file_type_transition_file ((type ARG1))
			    (call .tmp.file_type_transition
				  (ARG1 file file "*")))

		     (blockinherit .file.macro_template_files)
		     (blockinherit .file.tmp.base_template)))

       (block conf

	      (filecon "/etc/httpd" dir file_context)
	      (filecon "/etc/httpd/.*" any file_context)

	      (macro conf_file_type_transition_file ((type ARG1))
		     (call .conf.file_type_transition
			   (ARG1 file dir "httpd")))

	      (blockinherit .file.conf.httpd.template))

       (block data

	      (filecon "/usr/share/httpd" dir file_context)
	      (filecon "/usr/share/httpd/.*" any file_context)

	      (macro data_file_type_transition_file ((type ARG1))
		     (call .data.file_type_transition
			   (ARG1 file dir "httpd")))

	      (macro map_file_files ((type ARG1))
		     (allow ARG1 file (file (map))))

	      (blockinherit .file.data.template))

       (block exec

	      (filecon "/usr/bin/httpd" file file_context))

       (block htcacheclean

	      (blockinherit .sys.agent.template)

	      (call conf.read_file_files (subj))

	      (call httpd.cache.delete_file_dirs (subj))
	      (call httpd.cache.delete_file_files (subj))
	      (call httpd.cache.deletename_file_dirs (subj))

	      (call run.manage_file_dirs (subj))
	      (call run.manage_file_files (subj))

	      (call .cache.search_file_pattern.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block conf

		     (filecon "/etc/sysconfig/htcacheclean" file file_context)
		     (filecon "/etc/sysconfig/htcacheclean\..*" file
			      file_context)

		     (macro conf_file_type_transition_file ((type ARG1))
			    (call .conf.file_type_transition
				  (ARG1 file file "htcacheclean")))

		     (blockinherit .file.conf.httpd.base_template)
		     (blockinherit .file.macro_template_files))

	      (block exec

		     (filecon "/usr/bin/htcacheclean" file file_context))

	      (block run

		     (filecon "/run/httpd/htcacheclean" dir file_context)
		     (filecon "/run/httpd/htcacheclean/.*" any file_context)

		     (macro httpd_run_file_type_transition_file ((type ARG1))
			    (call .httpd.run.file_type_transition
				  (ARG1 file dir "htcacheclean")))

		     (blockinherit .file.run.httpd.template))

	      (block unit

		     (filecon "/usr/lib/systemd/system/htcacheclean\.service.*"
			      file file_context)

		     (blockinherit .file.unit.template)))

       (block log

	      (filecon "/var/log/httpd" dir file_context)
	      (filecon "/var/log/httpd/.*" any file_context)

	      (macro log_file_type_transition_file ((type ARG1))
		     (call .log.file_type_transition
			   (ARG1 file dir "httpd")))

	      (macro rename_file_files ((type ARG1))
		     (allow ARG1 file rename_file))

	      (macro setattr_file_files ((type ARG1))
		     (allow ARG1 file (file (setattr))))

	      (blockinherit .file.log.template))

       (block rotatelogs

	      (blockinherit .sys.agent.template)

	      (call httpd.log.manage_file_files (subj))
	      (call httpd.log.readwrite_file_dirs (subj))

	      (call .log.search_file_pattern.type (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (block exec

		     (filecon "/usr/bin/rotatelogs" file file_context)))

       (block run

	      (filecon "/run/httpd" dir file_context)
	      (filecon "/run/httpd/.*" any file_context)

	      (filecon "/run/mod_fcgid" dir file_context)
	      (filecon "/run/mod_fcgid/.*" any file_context)

	      (macro run_file_type_transition_file ((type ARG1))
		     (call .run.file_type_transition
			   (ARG1 file dir "httpd"))
		     (call .run.file_type_transition
			   (ARG1 file dir "mod_fcgid")))

	      (blockinherit .file.macro_template_sock_files)
	      (blockinherit .file.run.httpd.template))

       (block sslgencerts

	      (blockinherit .sys.agent.template)

	      (call httpd.conf.read_file_files (subj))
	      (call httpd.conf.search_file_dirs (subj))

	      (call .cert.manage_file_files (subj))
	      (call .cert.readwrite_file_dirs (subj))

	      (call .cryptopol.conf.read_file_files (subj))
	      (call .cryptopol.conf.traverse_file_pattern.type (subj))

	      (call .cryptopol.data.read_file_files (subj))
	      (call .cryptopol.data.search_file_pattern.type (subj))

	      ;; hostname
	      (call .exec.execute_file_files (subj))

	      (call .locale.data.map_file_pattern.type (subj))
	      (call .locale.data.read_file_pattern.type (subj))

	      (call .nss.passwdgroup.type (subj))

	      (call .openssl.exec.execute_file_files (subj))

	      (call .rbacsep.constrained.type (subj))
	      (call .rbacsep.usefdsource.type (subj))

	      (call .shell.exec.mapexecute_file_files (subj))
	      (call .shell.exec.read_file_files (subj))

	      (block exec

		     (filecon "/usr/bin/httpd-ssl-gencerts" file file_context)))

       (block state

	      (filecon "/var/lib/httpd" dir file_context)
	      (filecon "/var/lib/httpd/.*" any file_context)

	      (macro state_file_type_transition_file ((type ARG1))
		     (call .state.file_type_transition
			   (ARG1 file dir "httpd")))

	      (blockinherit .file.macro_template_dirs)
	      (blockinherit .file.macro_template_files)
	      (blockinherit .file.state.base_template))

       (block suexec

	      (blockinherit .sys.agent.template)

	      (allow subj self (capability (setgid setuid)))
	      (allow subj self create_unix_dgram_socket)

	      (call httpd.readwrite_subj_unix_stream_sockets (subj))

	      (call httpd.log.append_file_files (subj))
	      (call httpd.log.search_file_dirs (subj))

	      (call .crypto.read_sysctlfile_pattern.type (subj))

	      (call .exec.mapexecute_file_files (subj))
	      (call .exec.read_file_files (subj))

	      (call .kernel.read_sysctlfile_pattern.type (subj))

	      (call .locale.data.map_file_pattern.type (subj))
	      (call .locale.data.read_file_pattern.type (subj))

	      (call .log.search_file_pattern.type (subj))

	      (call .nss.passwdgroup.type (subj))

	      (call .random.read_sysctlfile_pattern.type (subj))

	      (call .selinux.linked.type (subj))

	      (call .shell.exec.mapexecute_file_files (subj))
	      (call .shell.exec.read_file_files (subj))

	      (call .state.search_file_pattern.type (subj))

	      (call .systemd.journal.relay_msgs.type (subj))

	      (call .user.home.search_file_pattern.type (subj))

	      (call .user.web.getattr_all_files (subj))
	      (call .user.web.list_all_dirs (subj))
	      (call .user.web.read_all_lnk_files (subj))

	      (call .user.web.script.signal_subj_processes (subj))
	      (call .user.web.script.subj_type_transition (subj))

	      (block exec

		     (filecon "/usr/bin/suexec" file file_context)))

       (block tmp

	      (macro tmp_file_type_transition_file ((type ARG1))
		     (call .tmp.file_type_transition
			   (ARG1 file file "*")))

	      (blockinherit .file.macro_template_files)
	      (blockinherit .file.tmp.base_template))

       (block unit

	      (filecon "/usr/lib/systemd/system/httpd-init\.service.*" file
		       file_context)
	      (filecon "/usr/lib/systemd/system/httpd\.service.*" file
		       file_context)
	      (filecon "/usr/lib/systemd/system/httpd@.*\.service.*" file
		       file_context)
	      (filecon "/usr/lib/systemd/system/httpd\.socket.*" file
		       file_context)

	      (blockinherit .file.unit.template)))

(in file.conf

    (block httpd

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)
	   (blockinherit file.all_macro_template_lnk_files)

	   (typeattribute typeattr)

	   (call file.conf.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.conf.base_template)

		  (call .file.conf.httpd.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.conf.httpd.base_template)
		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.macro_template_lnk_files))))

(in file.run

    (block httpd

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)
	   (blockinherit file.all_macro_template_sock_files)

	   (typeattribute typeattr)

	   (call file.run.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.run.base_template)

		  (call .file.run.httpd.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.macro_template_dirs)
		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.run.httpd.base_template))))

(in file.unconfined

    (call .httpd.cache.cache_file_type_transition_file (typeattr))
    (call .httpd.cert.cert_file_type_transition_file (typeattr))
    (call .httpd.conf.conf_file_type_transition_file (typeattr))
    (call .httpd.data.data_file_type_transition_file (typeattr))
    (call .httpd.htcacheclean.conf.conf_file_type_transition_file (typeattr))
    (call .httpd.htcacheclean.run.httpd_run_file_type_transition_file
	  (typeattr))
    (call .httpd.log.log_file_type_transition_file (typeattr))
    (call .httpd.run.run_file_type_transition_file (typeattr))
    (call .httpd.state.state_file_type_transition_file (typeattr)))
