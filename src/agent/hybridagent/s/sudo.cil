;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in file.run

    (block sudo

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (blockinherit file.all_macro_template_dirs)
	   (blockinherit file.all_macro_template_files)

	   (typeattribute typeattr)

	   (call file.run.type (typeattr))

	   (block base_template

		  (blockabstract base_template)

		  (blockinherit .file.run.base_template)

		  (call .file.run.sudo.type (file)))

	   (block template

		  (blockabstract template)

		  (blockinherit .file.run.sudo.base_template)
		  (blockinherit .file.macro_template_files))))

(in file.unconfined

    (call .sudo.cert.cert_file_type_transition_file (typeattr))
    (call .sudo.conf.conf_file_type_transition_file (typeattr))
    (call .sudo.log.log_file_type_transition_file (typeattr))
    (call .sudo.logsrv.conf.conf_file_type_transition_file (typeattr))
    (call .sudo.logsrv.run.sudo_run_file_type_transition_file (typeattr))
    (call .sudo.run.run_file_type_transition_file (typeattr))
    (call .sudo.state.state_file_type_transition_file (typeattr))
    (call .sudo.sudoers.conf_file_type_transition_file (typeattr)))

(in shell.exec

    (filecon "/usr/lib/sudo/sesh" file file_context))

(in sudo

    (blockinherit .dbus.client.template)
    (blockinherit .user.agent.template)

    (allow subj self
	   (capability (audit_control audit_write chown dac_override
				      dac_read_search fowner fsetid kill
				      setgid setuid sys_resource)))
    (allow subj self
	   (process (getpgid setpgid setexec setkeycreate setrlimit
			     setsched)))
    (allow subj self create_netlink_audit_socket)
    (allow subj self create_tcp_socket)
    (allow subj self create_unix_dgram_socket)
    (allow subj self
	   (netlink_audit_socket (nlmsg_read nlmsg_relay nlmsg_tty_audit)))

    (call cert.list_file_dirs (subj))
    (call cert.read_file_files (subj))

    (call conf.read_file_files (subj))

    (call log.log_file_type_transition_file (subj))
    (call log.manage_file_dirs (subj))
    (call log.manage_file_files (subj))

    (call logsrv.nameconnect_port_tcp_sockets (subj))

    (call run.manage_file_dirs (subj))
    (call run.manage_file_files (subj))
    (call run.run_file_type_transition_file (subj))

    (call state.manage_file_dirs (subj))
    (call state.manage_file_files (subj))
    (call state.state_file_type_transition_file (subj))

    (call sudoers.list_file_dirs (subj))
    (call sudoers.read_file_files (subj))

    (call tmp.manage_file_files (subj))
    (call tmp.tmp_file_type_transition_file (subj))

    (call .caplastcap.read_sysctlfile_pattern.type (subj))

    (call .cert.read_file_files (subj))
    (call .cert.traverse_file_pattern.type (subj))

    (call .checkcontext_selinux_security (subj))
    (call .computerelabel_selinux_security (subj))
    (call .computeuser_selinux_security (subj))

    (call .crypto.read_sysctlfile_pattern.type (subj))

    (call .dev.getattr_all_chr_files (subj))
    (call .dev.list_file_pattern.type (subj))

    (call .exec.mapexecute_file_files (subj))
    (call .exec.read_file_files (subj))

    (call .exec.home.mapexecute_file_files (subj))
    (call .exec.home.read_file_files (subj))

    (call .file.exec.getattr_all_files (subj))

    (call .ibac.objchangesys.type (subj))

    (call .initctl.getattr_file_fifo_files (subj))

    (call .kcore.getattr_procfile_files (subj))

    (call .locale.data.map_file_pattern.type (subj))
    (call .locale.read_file_pattern.type (subj))

    (call .ngroupsmax.read_sysctlfile_pattern.type (subj))

    (call .nss.hosts.type (subj))
    (call .nss.passwdgroup.type (subj))

    (call .pam.linked.type (subj))

    (call .proc.getattr_fs_pattern.type (subj))

    (call .ptmx.readwrite_nodedev_chr_files (subj))

    (call .random.read_sysctlfile_pattern.type (subj))

    (call .rbac.change.type (subj))

    (call .rbacsep.exempt.subj.type (subj))
    (call .rbacsep.usefdtarget.type (subj))

    (call .selinux.default.read_file_pattern.type (subj))

    (call .shell.exec.mapexecute_file_files (subj))
    (call .shell.exec.read_file_files (subj))

    (call .stat.read_procfile_files (subj))

    (call .stordev.getattr_all_blk_files (subj))

    (call .subj.common.dontaudit_ps_all_states (subj))

    (call .sys.search_subj_keyrings (subj))

    (call .sys.termdev.readwrite_all_chr_files (subj))
    (call .sys.termdev.relabel_all_chr_files (subj))
    (call .sys.termdev.setattr_all_chr_files (subj))

    (call .sys.user.create_subj_keyrings (subj))
    (call .sys.user.rlimitinh_subj_processes (subj))
    (call .sys.user.signal_subj_processes (subj))
    (call .sys.user.signull_subj_processes (subj))
    (call .sys.user.transition_subj_processes (subj))

    (call .systemd.journal.relay_msgs.type (subj))

    (call .systemd.login.sendmsg_subj_dbus.type (subj))

    (call .user.devpts_fs_type_transition_ptytermdev (subj))

    (call .user.getpgid_all_processes (subj))

    (call .user.run.search_file_pattern.type (subj))

    (call .user.termdev.readwrite_all_chr_files (subj))
    (call .user.termdev.relabel_all_chr_files (subj))
    (call .user.termdev.setattr_all_chr_files (subj))

    (call .user.priv.create_all_keyrings (subj))
    (call .user.priv.rlimitinh_all_processes (subj))
    (call .user.priv.signal_all_processes (subj))
    (call .user.priv.signull_all_processes (subj))
    (call .user.priv.transition_all_processes (subj))

    (call .user.systemd.getpgid_subj_processes (subj))

    (optional sudo_gnupgagent
	      (call .gnupg.agent.unix_stream_connect (subj)))

    (optional sudo_opensshserver
	      (call .openssh.server.unix_stream_connect (subj)))

    (block cert

	   (filecon "/etc/ssl/sudo" dir file_context)
	   (filecon "/etc/ssl/sudo/.*" any file_context)

	   (macro cert_file_type_transition_file ((type ARG1))
		  (call .cert.file_type_transition
			(ARG1 file dir "sudo")))

	   (blockinherit .file.cert.template))

    (block client

	   (macro type ((type ARG1))
		  (typeattributeset typeattr ARG1))

	   (typeattribute typeattr)

	   (call sudo.noatsecure_subj_processes (typeattr))
	   (call sudo.readinherited_subj_fifo_files (typeattr))
	   (call sudo.use_subj_fds (typeattr))

	   (call sudo.tmp.manage_file_files (typeattr))
	   (call sudo.tmp.relabel_file_files (typeattr)))

    (block conf

	   (filecon "/etc/sudo\.conf" file file_context)
	   (filecon "/etc/sudo\.conf\..*" file file_context)

	   (macro conf_file_type_transition_file ((type ARG1))
		  (call .conf.file_type_transition
			(ARG1 file file "sudo.conf")))

	   (blockinherit .file.conf.base_template)
	   (blockinherit .file.macro_template_files))

    (block exec

	   (filecon "/usr/bin/sudo" file file_context))

    (block log

	   (filecon "/var/log/sudo" dir file_context)
	   (filecon "/var/log/sudo/.*" any file_context)
	   (filecon "/var/log/sudo\.log" file file_context)
	   (filecon "/var/log/sudo\.log\..*" file file_context)
	   (filecon "/var/log/sudo-io" dir file_context)
	   (filecon "/var/log/sudo-io/.*" any file_context)
	   (filecon "/var/log/sudo_debug" file file_context)
	   (filecon "/var/log/sudo_debug\..*" file file_context)
	   (filecon "/var/log/sudoers_debug" file file_context)
	   (filecon "/var/log/sudoers_debug\..*" file file_context)

	   (macro log_file_type_transition_file ((type ARG1))
		  (call .log.file_type_transition
			(ARG1 file dir "sudo"))
		  (call .log.file_type_transition
			(ARG1 file dir "sudo-io"))
		  (call .log.file_type_transition
			(ARG1 file file "sudo.log"))
		  (call .log.file_type_transition
			(ARG1 file file "sudo_debug"))
		  (call .log.file_type_transition
			(ARG1 file file "sudoers_debug")))

	   (blockinherit .file.log.template))

    (block replay

	   (blockinherit .user.agent.template)

	   (call conf.read_file_files (subj))

	   (call log.list_file_dirs (subj))
	   (call log.read_file_files (subj))

	   (call .log.search_file_pattern.type (subj))

	   (block exec

		  (filecon "/usr/bin/sudoreplay" file file_context)))

    (block run

	   (filecon "/run/sudo" dir file_context)
	   (filecon "/run/sudo/.*" any file_context)
	   (filecon "/run/sudo/ts/%{USERNAME}" file file_context)

	   (macro run_file_type_transition_file ((type ARG1))
		  (call .run.file_type_transition
			(ARG1 file dir "sudo")))

	   (blockinherit .file.macro_template_dirs)
	   (blockinherit .file.run.sudo.template))

    (block sendlog

	   (blockinherit .hybrid.agent.template)

	   (allow subj self create_tcp_socket)

	   (call cert.list_file_dirs (subj))
	   (call cert.read_file_files (subj))

	   (call logsrv.nameconnect_port_tcp_sockets (subj))

	   (call .cert.read_file_files (subj))
	   (call .cert.traverse_file_pattern.type (subj))

	   (call .crypto.read_sysctlfile_pattern.type (subj))

	   (call .nss.hosts.type (subj))

	   (call .rbacsep.constrained.type (subj))

	   (block exec

		  (filecon "/usr/bin/sudo_sendlog" file file_context)))

    (block state

	   (filecon "/var/lib/sudo" dir file_context)
	   (filecon "/var/lib/sudo/.*" any file_context)
	   (filecon "/var/lib/sudo/lectured/%{USERNAME}" file file_context)

	   (macro state_file_type_transition_file ((type ARG1))
		  (call .state.file_type_transition
			(ARG1 file dir "sudo")))

	   (blockinherit .file.macro_template_dirs)
	   (blockinherit .file.macro_template_files)
	   (blockinherit .file.state.base_template))

    (block sudoers

	   (filecon "/etc/sudoers" file file_context)
	   (filecon "/etc/sudoers\..*" file file_context)
	   (filecon "/etc/sudoers\.d" dir file_context)
	   (filecon "/etc/sudoers\.d/.*" any file_context)

	   (macro conf_file_type_transition_file ((type ARG1))
		  (call .conf.file_type_transition
			(ARG1 file dir "sudoers.d"))
		  (call .conf.file_type_transition
			(ARG1 file file "sudoers")))

	   (blockinherit .file.macro_template_dirs)
	   (blockinherit .file.macro_template_files)
	   (blockinherit .file.sec.base_template))

    (block tmp

	   (macro tmp_file_type_transition_file ((type ARG1))
		  (call .tmp.file_type_transition
			(ARG1 file file "*")))

	   (blockinherit .file.macro_template_files)
	   (blockinherit .file.user.tmp.base_template))

    (block visudo

	   (macro subj_type_transition ((type ARG1))
		  (allow ARG1 subj (process (noatsecure transition)))

		  (allow subj ARG1 (process (sigchld)))
		  (allow subj ARG1 (fd (use)))
		  (allow subj ARG1 readwriteinherited_fifo_file)

		  (call exec.mapexecute_file_files (ARG1))
		  (call exec.read_file_files (ARG1))
		  (call exec.subj_type_transition (ARG1 subj)))

	   (blockinherit .sys.agent.template)

	   (allow subj self (capability (dac_read_search dac_override)))

	   (call conf.read_file_files (subj))

	   (call sudoers.conf_file_type_transition_file (subj))
	   (call sudoers.manage_file_files (subj))
	   (call sudoers.readwrite_file_dirs (subj))

	   (call .crypto.read_sysctlfile_pattern.type (subj))

	   (call .editor.conf.read_file_files (subj))

	   (call .exec.execute_file_files (subj))

	   (call .file.home.dontaudit_listinherited_all_dirs (subj))
	   (call .file.sec.write.type (subj))

	   (call .locale.data.map_file_pattern.type (subj))
	   (call .locale.read_file_pattern.type (subj))

	   (call .nss.passwdgroup.type (subj))

	   (call .rbacsep.constrained.type (subj))
	   (call .rbacsep.usefdsource.type (subj))

	   (call .selinux.linked.type (subj))

	   (call .shell.exec.execute_file_files (subj))

	   (call .terminfo.read_file_pattern.type (subj))

	   (block exec

		  (filecon "/usr/bin/visudo" file file_context))))

(in sudo.logsrv

    (blockinherit .sys.agent.template)

    (allow subj self create_tcp_stream_socket)
    (allow subj self create_unix_dgram_socket)

    (call namebind_port_tcp_sockets (subj))

    (call cert.list_file_dirs (subj))
    (call cert.read_file_files (subj))

    (call conf.read_file_files (subj))

    (call log.manage_file_dirs (subj))
    (call log.manage_file_files (subj))
    (call log.log_file_type_transition_file (subj))

    (call run.manage_file_files (subj))
    (call run.sudo_run_file_type_transition_file (subj))

    (call sudo.conf.read_file_files (subj))

    (call sudo.run.deletename_file_dirs (subj))

    (call .cert.read_file_files (subj))
    (call .cert.traverse_file_pattern.type (subj))

    (call .crypto.read_sysctlfile_pattern.type (subj))

    (call .net.nodebind_netnode_tcp_sockets (subj))

    (call .nss.hosts.type (subj))

    (call .rbacsep.constrained.type (subj))
    (call .rbacsep.usefdsource.type (subj))

    (call .systemd.journal.relay_msgs.type (subj))

    (block conf

	   (filecon "/etc/sudo_logsrvd\.conf" file file_context)
	   (filecon "/etc/sudo_logsrvd\.conf\..*" file file_context)

	   (macro conf_file_type_transition_file ((type ARG1))
		  (call .conf.file_type_transition
			(ARG1 file file "sudo_logsrvd.conf")))

	   (blockinherit .file.conf.base_template)
	   (blockinherit .file.macro_template_files))

    (block exec

	   (filecon "/usr/bin/sudo_logsrvd" file file_context))

    (block run

	   (filecon "/run/sudo/sudo_logsrvd\.pid" file file_context)
	   (filecon "/run/sudo/sudo_logsrvd\.pid\..*" file file_context)

	   (macro sudo_run_file_type_transition_file ((type ARG1))
		  (call .sudo.run.file_type_transition
			(ARG1 file file "sudo_logsrvd.pid")))

	   (blockinherit .file.run.sudo.template)))

(in sys.agent

    (call .sudo.sigchld_subj_processes (typeattr))
    (call .sudo.use_subj_fds (typeattr)))

(in user

    (call .sudo.client.type (subj)))

(in user.priv

    (call .sudo.conf.read_file_files (typeattr))
    (call .sudo.use_subj_fds (typeattr))

    (call .sys.termdev.readwrite_all_chr_files (typeattr))
    (call .sys.termdev.user_all_type_change (typeattr)))

(in wheel

    (call .sudo.role (role)))
