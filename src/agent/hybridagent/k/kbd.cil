;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(block kbd

       (blockinherit .hybrid.agent.template)

       (allow subj self (capability (sys_tty_config)))

       (call data.list_file_dirs (subj))
       (call data.read_file_files (subj))

       (call .exec.execute_file_files (subj))

       (call .locale.data.map_file_pattern.type (subj))
       (call .locale.read_file_pattern.type (subj))

       (call .nss.passwdgroup.type (subj))

       (call .rbacsep.constrained.type (subj))

       (call .shell.exec.execute_file_files (subj))

       (call .src.search_file_dirs (subj))

       (call .sys.open_ptytermdev_chr_files (subj))

       (call .sys.open_serialtermdev_chr_files (subj))

       (call .systemd.udev.use_subj_fds (subj))
       (call .systemd.udev.writeinherited_subj_fifo_files (subj))

       (call .tty.open_serialtermdev_chr_files (subj))

       (optional kbd_userptytermdev
		 (call .user.open_ptytermdev_chr_files (subj)))

       (optional kbd_userserialtermdev
		 (call .user.open_serialtermdev_chr_files (subj)))

       (block data

	      (filecon "/usr/share/X11/xkb" dir file_context)
	      (filecon "/usr/share/X11/xkb/.*" any file_context)

	      (macro data_file_type_transition_file ((type ARG1))
		     (call .data.file_type_transition
			   (ARG1 file dir "xkb")))

	      (blockinherit .file.data.template))

       (block exec

	      (filecon "/usr/bin/chvt" file file_context)
	      (filecon "/usr/bin/codepage" file file_context)
	      (filecon "/usr/bin/deallocvt" file file_context)
	      (filecon "/usr/bin/dumpkeys" file file_context)
	      (filecon "/usr/bin/fgconsole" file file_context)
	      (filecon "/usr/bin/getkeycodes" file file_context)
	      (filecon "/usr/bin/kbd_mode" file file_context)
	      (filecon "/usr/bin/kbdinfo" file file_context)
	      (filecon "/usr/bin/kbdrate" file file_context)
	      (filecon "/usr/bin/loadkeys" file file_context)
	      (filecon "/usr/bin/loadunimap" file file_context)
	      (filecon "/usr/bin/mapscrn" file file_context)
	      (filecon "/usr/bin/mk_modmap" file file_context)
	      (filecon "/usr/bin/openvt" file file_context)
	      (filecon "/usr/bin/psfxtable" file file_context)
	      (filecon "/usr/bin/resizecons" file file_context)
	      (filecon "/usr/bin/setfont" file file_context)
	      (filecon "/usr/bin/setkeycodes" file file_context)
	      (filecon "/usr/bin/setleds" file file_context)
	      (filecon "/usr/bin/setlogcons" file file_context)
	      (filecon "/usr/bin/setmetamode" file file_context)
	      (filecon "/usr/bin/setvesablank" file file_context)
	      (filecon "/usr/bin/setvtrgb" file file_context)
	      (filecon "/usr/bin/showconsolefont" file file_context)
	      (filecon "/usr/bin/showkey" file file_context)
	      (filecon "/usr/bin/splitfont" file file_context)
	      (filecon "/usr/bin/unicode_stop" file file_context)
	      (filecon "/usr/bin/vcstime" file file_context)))

(in file.unconfined

    (call .kbd.data.data_file_type_transition_file (typeattr)))
