;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(in consolesetup

    (block setupcon

	   (blockinherit .hybrid.agent.template)

	   (allow subj self (capability (mknod)))
	   (allow subj self (process (getsched setfscreate)))
	   (dontaudit subj self (capability (sys_ptrace)))

	   (call conf.manage_file_files (subj))
	   (call conf.readwrite_file_dirs (subj))

	   (call data.list_file_dirs (subj))
	   (call data.read_file_files (subj))

	   (call exec.execute_file_files (subj))

	   (call home.read_file_files (subj))

	   (call run.manage_file_dirs (subj))
	   (call run.manage_file_files (subj))
	   (call run.run_file_type_transition_file (subj))

	   (call tmp.manage_file_files (subj))
	   (call tmp.tmp_file_type_transition_file (subj))

	   (call .dev.list_file_pattern.type (subj))

	   (call .devpts.search_fs_pattern.type (subj))

	   (call .exec.execute_file_files (subj))

	   (call .file.exec.getattr_all_files (subj))

	   (call .ibac.objchangesys.type (subj))

	   (call .kbd.data.read_file_pattern.type (subj))
	   (call .kbd.subj_type_transition (subj))

	   (call .locale.data.map_file_pattern.type (subj))
	   (call .locale.read_file_pattern.type (subj))

	   (call .null.manage_nodedev_chr_files (subj))

	   (call .perl5.data.search_file_dirs (subj))

	   (call .proc.list_fs_dirs (subj))

	   (call .random.read_nodedev_chr_files (subj))

	   (call .rbac.objchangesys.type (subj))

	   (call .root.list_file_dirs (subj))

	   (call .shell.exec.execute_file_files (subj))

	   (call .selinux.linked.type (subj))

	   (call .subj.common.dontaudit_read_all_states (subj))
	   (call .subj.common.read_all_states (subj))

	   (call .sys.home.dontaudit_list_file_dirs (subj))

	   (call .sys.termdev.open_all_chr_files (subj))

	   (call .sys.read_subj_states (subj))

	   (call .sys.user.read_subj_states (subj))

	   (call .sysctl.conf.read_file_files (subj))
	   (call .sysctl.subj_type_transition (subj))

	   (call .tmp.deletename_file_dirs (subj))

	   (call .tty.open_serialtermdev_chr_files (subj))

	   (call .var.traverse_file_pattern.type (subj))

	   (call .user.home.search_file_pattern.type (subj))

	   (optional consolesetupcon_initramfstools
		     (call .initramfstools.tmp.manage_file_files (subj))
		     (call .initramfstools.tmp.manage_file_dirs (subj))
		     (call .initramfstools.tmp.read_file_lnk_files (subj)))

	   (optional consolesetupcon_systemdnspawn
		     (call .systemd.nspawn.container.subj.read_all_states
			   (subj)))

	   (optional consolesetupcon_usertermdev
		     (call .user.termdev.open_all_chr_files (subj)))

	   (block exec

		  (filecon "/usr/bin/setupcon" file file_context))

	   (block home

		  (filecon "HOME_DIR/\.console-setup" file file_context)
		  (filecon "HOME_DIR/\.console-setup\..*" file file_context)
		  (filecon "HOME_DIR/\.keyboard" file file_context)
		  (filecon "HOME_DIR/\.keyboard\..*" file file_context)

		  (macro user_home_file_type_transition_file ((type ARG1))
			 (call .user.home.file_type_transition
			       (ARG1 file file ".console-setup"))
			 (call .user.home.file_type_transition
			       (ARG1 file file ".keyboard")))

		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.user.home.base_template))

	   (block tmp

		  (macro tmp_file_type_transition_file ((type ARG1))
			 (call .tmp.file_type_transition
			       (ARG1 file file "*")))

		  (blockinherit .file.macro_template_files)
		  (blockinherit .file.user.tmp.base_template))))

(in file.unconfined

    (call .consolesetup.setupcon.home.user_home_file_type_transition_file
	  (typeattr)))

(in kbd

    (call .consolesetup.setupcon.tmp.read_file_files (subj)))

(in null

    (call .xattr.associate_fs (nodedev)))
