;; SPDX-FileCopyrightText: Â© 2021 Dominick Grift <dominick.grift@defensec.nl>
;; SPDX-License-Identifier: Unlicense

(block wireplumber

       (blockinherit .dbus.client.macro_template)
       (blockinherit .user.agent.template)

       (allow subj self create_bluetooth_socket)
       (allow subj self create_netlink_kobject_uevent_socket)
       (allow subj self (bluetooth_socket (listen)))

       (call data.list_file_dirs (subj))
       (call data.map_file_files (subj))
       (call data.read_file_files (subj))

       (call home.data.manage_file_dirs (subj))
       (call home.data.manage_file_files (subj))
       (call home.data.user_home_data_file_type_transition_file (subj))

       (call .alsa.conf.read_file_files (subj))

       (call .alsa.data.read_file_files (subj))
       (call .alsa.data.search_file_dirs (subj))

       (call .bus.list_sysfile_pattern.type (subj))
       (call .bus.read_sysfile_lnk_files (subj))

       (call .class.list_sysfile_pattern.type (subj))
       (call .class.read_sysfile_lnk_files (subj))

       (call .dbus.client.type (subj))

       (call .dev.list_file_pattern.type (subj))
       (call .dev.watch_file_dirs (subj))

       (call .locale.data.map_file_pattern.type (subj))
       (call .locale.data.read_file_pattern.type (subj))

       (call .pipewire.common.type (subj))
       (call .pipewire.unix_stream_connect (subj))

       (call .rtkit.client.type (subj))

       (call .snd.map_nodedev_chr_files (subj))
       (call .snd.readwrite_nodedev_chr_files (subj))

       (call .state.search_file_pattern.type (subj))

       (call .systemd.udev.run.read_file_pattern.type (subj))

       (call .user.home.data.create_file_dir_pattern.type (subj))

       (call .user.dbus.nameclient.type (subj))

       (call .user.run.search_file_pattern.type (subj))

       (call .user.systemd.agent (subj exec.file))
       (call .user.systemd.service.nnptransition.type (subj))

       (call .v4l.readwrite_nodedev_chr_files (subj))

       (call .xattr.getattr_fs_pattern.type (subj))

       (optional wireplumber_bluez
		 (call .bluez.sendmsg_subj_dbus.type (subj)))

       (block data

	      (filecon "/usr/share/wireplumber" dir file_context)
	      (filecon "/usr/share/wireplumber/.*" any file_context)

	      (macro data_file_type_transition_file ((type ARG1))
		     (call .data.file_type_transition
			   (ARG1 file dir "wireplumber")))

	      (macro map_file_files ((type ARG1))
		     (allow ARG1 file (file (map))))

	      (blockinherit .file.data.template))

       (block exec

	      (filecon "/usr/bin/wireplumber" file file_context))

       (block home

	      (block data

		     (filecon "HOME_DIR/\.local/state/wireplumber" dir
			      file_context)
		     (filecon "HOME_DIR/\.local/state/wireplumber/.*" any
			      file_context)

		     (macro user_home_data_file_type_transition_file
			    ((type ARG1))
			    (call .user.home.data.file_type_transition
				  (ARG1 file dir "wireplumber")))

		     (blockinherit .file.user.home.data.template)))

       (block unit

	      (filecon "/usr/lib/systemd/user/wireplumber\.service.*" file
		       file_context)
	      (filecon "/usr/lib/systemd/user/wireplumber@.*\.service.*" file
		       file_context)

	      (blockinherit .file.user.unit.template))

       (block util

	      (blockinherit .user.agent.template)

	      (call home.data.list_file_dirs (subj))
	      (call home.data.read_file_files (subj))

	      (call .gcrypt.conf.read_file_pattern.type (subj))

	      (call .pipewire.common.type (subj))
	      (call .pipewire.unix_stream_connect (subj))

	      (call .user.home.data.search_file_pattern.type (subj))

	      (call .user.run.search_file_pattern.type (subj))

	      (block exec

		     (filecon "/usr/bin/wpctl" file file_context)
		     (filecon "/usr/bin/wpexec" file file_context))))

(in file.unconfined

    (call .wireplumber.data.data_file_type_transition_file (typeattr))
    (call .wireplumber.home.data.user_home_data_file_type_transition_file
	  (typeattr)))

(in pipewire

    (call .wireplumber.read_subj_states (subj))
    (call .wireplumber.util.read_subj_states (subj)))

(in user

    (call .wireplumber.home.data.manage_file_dirs (subj))
    (call .wireplumber.home.data.manage_file_files (subj))
    (call .wireplumber.home.data.relabel_file_dirs (subj))
    (call .wireplumber.home.data.relabel_file_files (subj))
    (call .wireplumber.home.data.user_home_data_file_type_transition_file
	  (subj))

    (call .wireplumber.role (role))
    (call .wireplumber.util.role (role)))

(in wheel

    (call .wireplumber.role (role))
    (call .wireplumber.util.role (role)))
